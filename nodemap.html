<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Appliance Node Map - ExtraHop API Tools</title>
    <link rel="icon" href="favicon.png" type="image/png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Source+Sans+3:wght@400;600;700&display=swap" rel="stylesheet">
    
    <!-- Load modular CSS -->
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <!-- TOP RIBBON -->
    <div class="top-ribbon">
        <img src="eh_logo.png" alt="ExtraHop" class="ribbon-logo">
        <span class="ribbon-title">API Tools</span>
        <span id="ribbonModuleTitle" class="ribbon-module-title">Appliance Node Map</span>
    </div>

    <!-- MAIN CONTENT -->
    <div class="content-wrapper flex flex-col lg:flex-row min-h-screen">
        <!-- SIDEBAR -->
        <aside class="w-full lg:w-80 border-r p-6 space-y-6 lg:fixed lg:h-full lg:overflow-y-auto">
            <!-- API Configuration Section -->
            <div id="apiConfigSection" class="space-y-4">
                <!-- Connected State (Hidden Initially) -->
                <div id="connectedState" class="hidden">
                    <div class="flex items-center justify-between p-3 rounded cursor-pointer" style="background-color: var(--bg-subtle);" onclick="toggleApiConfig()">
                        <div class="flex items-center">
                            <svg class="w-5 h-5 mr-2" style="color: var(--cyan);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <span class="font-semibold" style="color: var(--text-primary);">Connected</span>
                        </div>
                        <svg id="expandIcon" class="w-5 h-5 transition-transform" style="color: var(--text-secondary);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </div>
                    <p class="text-xs mt-2 text-center" style="color: var(--text-muted);" id="connectedInfo"></p>
                </div>

                <!-- Configuration Form -->
                <div id="configForm">
                    <h2 class="text-lg font-semibold" style="color: var(--text-primary);">API Configuration</h2>
                    
                    <!-- Deployment Type -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-2" style="color: var(--text-secondary);">Deployment Type</label>
                        <select id="deploymentType" class="w-full px-3 py-2 rounded border">
                            <option value="360">RevealX 360 (Cloud)</option>
                            <option value="enterprise">RevealX Enterprise (On-Premises)</option>
                        </select>
                    </div>

                    <!-- 360 Configuration -->
                    <div id="config360" class="space-y-3">
                        <div class="mb-4">
                            <label class="block text-sm font-medium mb-2" style="color: var(--text-secondary);">Tenant Name</label>
                            <input type="text" id="tenantName" placeholder="e.g., extrahop-se" class="w-full px-3 py-2 rounded border">
                            <p class="text-xs mt-1" style="color: var(--text-muted);">From: tenant.api.cloud.extrahop.com</p>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium mb-2" style="color: var(--text-secondary);">API ID</label>
                            <input type="text" id="apiId" class="w-full px-3 py-2 rounded border">
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium mb-2" style="color: var(--text-secondary);">API Secret</label>
                            <input type="password" id="apiSecret" class="w-full px-3 py-2 rounded border">
                        </div>
                        <div class="mb-4">
                            <label class="flex items-center cursor-pointer">
                                <input type="checkbox" id="useAwsProxy" checked class="mr-2">
                                <span class="text-sm" style="color: var(--text-secondary);">Use AWS Proxy</span>
                            </label>
                        </div>
                    </div>

                    <!-- Enterprise Configuration -->
                    <div id="configEnterprise" class="space-y-3" style="display: none;">
                        <div class="mb-4">
                            <label class="block text-sm font-medium mb-2" style="color: var(--text-secondary);">Hostname or IP</label>
                            <input type="text" id="enterpriseHost" placeholder="e.g., extrahop.company.com" class="w-full px-3 py-2 rounded border">
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium mb-2" style="color: var(--text-secondary);">API Key</label>
                            <input type="password" id="enterpriseApiKey" class="w-full px-3 py-2 rounded border">
                        </div>
                    </div>

                    <button id="connectBtn" class="btn-primary w-full py-2 px-4 rounded font-semibold">
                        Connect
                    </button>
                </div>
            </div>

            <!-- Connection Status -->
            <div id="connectionStatus" style="display: none;">
                <div class="p-3 rounded" style="background-color: var(--bg-card); border: 1px solid var(--border-color);">
                    <p id="statusText" class="text-sm font-medium"></p>
                </div>
            </div>

            <!-- Controls -->
            <div id="controls" style="display: none;">
                <h2 class="text-lg font-semibold mb-4" style="color: var(--text-primary);">Controls</h2>
                
                <div class="space-y-4">
                    <button id="loadAppliances" class="btn-primary w-full py-2 px-4 rounded font-semibold">
                        Load Appliances
                    </button>
                    
                    <div class="relative">
                        <input type="text" id="searchInput" placeholder="Search appliances..." 
                               class="w-full px-3 py-2 rounded border">
                    </div>
                </div>
            </div>
        </aside>

        <!-- MAIN CONTENT AREA -->
        <main class="flex-1 lg:ml-80 min-h-screen" style="background-color: var(--bg-primary);">
            <!-- Welcome Screen -->
            <div id="welcomeScreen" class="flex items-center justify-center h-full">
                <div class="text-center p-8">
                    <img src="eh_logo.png" alt="ExtraHop" class="mx-auto mb-6 h-16">
                    <h1 class="text-3xl font-bold mb-4" style="color: var(--sapphire);">Appliance Node Map</h1>
                    <p class="text-lg mb-6" style="color: var(--text-secondary);">Visualize your ExtraHop appliance topology</p>
                    <div class="max-w-md mx-auto" style="color: var(--text-muted);">
                        <p class="text-sm">Connect to your ExtraHop deployment to view the appliance network topology and relationships.</p>
                    </div>
                </div>
            </div>

            <!-- Graph Container -->
            <div id="graphContainer" class="w-full h-full" style="display: none;">
                <svg id="nodeGraph" class="w-full h-full"></svg>
            </div>

            <!-- Node Details Modal -->
            <div id="nodeDetailsModal" class="modal">
                <div class="modal-content">
                    <h2 class="text-xl font-bold mb-4" style="color: var(--text-primary);">Appliance Details</h2>
                    <div id="nodeDetailsContent">
                        <!-- Node details will be populated here -->
                    </div>
                    <div class="flex justify-end mt-6">
                        <button onclick="hideModal('nodeDetailsModal')" class="btn-primary px-4 py-2 rounded">Close</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Error Modal -->
    <div id="errorModal" class="modal">
        <div class="modal-content">
            <h2 class="text-xl font-bold mb-4" style="color: var(--text-primary);">Connection Error</h2>
            <p id="errorMessage" class="mb-4" style="color: var(--text-secondary);"></p>
            
            <div class="mb-4">
                <button id="toggleErrorDetails" class="btn-secondary px-4 py-2 rounded text-sm">
                    Show Technical Details
                </button>
            </div>
            
            <div id="errorDetails" style="display: none;">
                <div class="bg-gray-50 p-3 rounded text-xs space-y-2">
                    <div><strong>URL:</strong> <code id="errorUrl"></code></div>
                    <div><strong>Headers:</strong> <pre id="errorHeaders" class="whitespace-pre-wrap"></pre></div>
                    <div><strong>Body:</strong> <pre id="errorBody" class="whitespace-pre-wrap"></pre></div>
                    <div><strong>Status:</strong> <code id="errorStatus"></code></div>
                    <div><strong>Response:</strong> <pre id="errorResponse" class="whitespace-pre-wrap"></pre></div>
                </div>
            </div>
            
            <div class="flex justify-end mt-6">
                <button id="closeErrorModal" class="btn-primary px-4 py-2 rounded">Close</button>
            </div>
        </div>
    </div>

    <!-- Load JavaScript Modules -->
    <script src="js/utils/app-state.js"></script>
    <script src="js/api-client/extrahop-api.js"></script>
    <script src="js/utils/common.js"></script>
    <script src="js/auth/auth-manager.js"></script>
    <script src="js/modules/nodemap.js"></script>

    <script>
        // Initialize nodemap-specific functionality
        window.addEventListener('DOMContentLoaded', () => {
            // Set up deployment type toggle
            document.getElementById('deploymentType').addEventListener('change', (e) => {
                const is360 = e.target.value === '360';
                document.getElementById('config360').style.display = is360 ? 'block' : 'none';
                document.getElementById('configEnterprise').style.display = is360 ? 'none' : 'block';
            });

            // Set up connect button
            document.getElementById('connectBtn').addEventListener('click', handleConnect);
            
            // Set up modal controls
            document.getElementById('closeErrorModal').addEventListener('click', () => hideModal('errorModal'));
            document.getElementById('toggleErrorDetails').addEventListener('click', function() {
                const detailsDiv = document.getElementById('errorDetails');
                if (detailsDiv.style.display === 'none') {
                    detailsDiv.style.display = 'block';
                    this.textContent = 'Hide Technical Details';
                } else {
                    detailsDiv.style.display = 'none';
                    this.textContent = 'Show Technical Details';
                }
            });

            // Initialize nodemap module
            initNodemapModule();
            
            // Load saved config
            const savedConfig = sessionStorage.getItem('eh_config');
            if (savedConfig) {
                const config = JSON.parse(savedConfig);
                if (config.type === '360') {
                    document.getElementById('deploymentType').value = '360';
                    document.getElementById('tenantName').value = config.tenant;
                    document.getElementById('apiId').value = config.apiId;
                    document.getElementById('apiSecret').value = config.apiSecret;
                    document.getElementById('useAwsProxy').checked = config.useProxy !== false;
                } else {
                    document.getElementById('deploymentType').value = 'enterprise';
                    document.getElementById('enterpriseHost').value = config.host;
                    document.getElementById('enterpriseApiKey').value = config.apiKey;
                    document.getElementById('config360').style.display = 'none';
                    document.getElementById('configEnterprise').style.display = 'block';
                }
            }
        });
    </script>
</body>
</html>