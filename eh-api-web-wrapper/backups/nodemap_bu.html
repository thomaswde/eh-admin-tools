<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Appliance Node Map - ExtraHop API Tools</title>
    <link rel="icon" href="favicon.png" type="image/png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Source+Sans+3:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f9fafb;
            --bg-card: #ffffff;
            --bg-input: #ffffff;
            --bg-hover: #f3f4f6;
            --bg-subtle: #f3f4f6;
            --text-primary: #261f63;
            --text-secondary: #4b5563;
            --text-muted: #6b7280;
            --border-color: #e5e7eb;
            --sapphire: #261f63;
            --plum: #7f2854;
            --magenta: #ec0089;
            --cyan: #00aaef;
            --tangerine: #f05918;
            --lime: #dae343;
            --ribbon-height: 60px;
        }

        .dark-theme {
            --bg-primary: #1f1f1f;
            --bg-secondary: #313131;
            --bg-card: #424242;
            --bg-input: #424242;
            --bg-hover: #535353;
            --bg-subtle: #424242;
            --text-primary: #f3f4f6;
            --text-secondary: #d1d5db;
            --text-muted: #9ca3af;
            --border-color: #4b5563;
        }

        body {
            font-family: 'Source Sans 3', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            padding-top: var(--ribbon-height);
        }

        .top-ribbon {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: var(--ribbon-height);
            background-color: var(--bg-card);
            border-bottom: 2px solid var(--border-color);
            display: flex;
            align-items: center;
            padding: 0 24px;
            z-index: 100;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .ribbon-logo {
            height: 40px;
            width: auto;
        }

        .ribbon-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
            margin-left: 16px;
        }

        .ribbon-module-title {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            font-size: 18px;
            font-weight: 600;
            color: var(--sapphire);
        }

        .content-wrapper {
            min-height: calc(100vh - var(--ribbon-height));
        }

        aside { 
            background-color: var(--bg-secondary); 
            border-color: var(--border-color); 
        }

        .btn-primary {
            background-color: var(--cyan);
            color: white;
            transition: all 0.2s;
        }

        .btn-primary:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background-color: var(--bg-card);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            transition: all 0.2s;
        }

        .btn-secondary:hover {
            background-color: var(--bg-hover);
        }

        input[type="text"], 
        input[type="password"],
        select {
            background-color: var(--bg-input);
            border-color: var(--border-color);
            color: var(--text-primary);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background-color: var(--bg-card);
            border-radius: 8px;
            padding: 24px;
            max-width: 700px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .spinner {
            border: 3px solid var(--bg-subtle);
            border-top: 3px solid var(--cyan);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .node-group {
            cursor: pointer;
        }
        
        .node-rect {
            stroke-width: 2;
            transition: all 0.3s ease;
        }
        
        .node-rect.virtual {
            stroke-dasharray: 5,5;
        }
        
        .node-rect:hover {
            filter: brightness(1.1);
            stroke-width: 3;
        }
        
        .node-text {
            pointer-events: none;
            user-select: none;
        }
        
        .offline-indicator {
            fill: #ef4444;
        }
        
        .link {
            fill: none;
            stroke: var(--border-color);
            stroke-width: 2;
        }

        .detail-panel {
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-secondary); }
        ::-webkit-scrollbar-thumb { background: #9ca3af; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
    </style>
</head>
<body>
    <!-- Fixed Top Ribbon -->
    <div class="top-ribbon">
        <img src="eh_logo.png" alt="ExtraHop" class="ribbon-logo">
        <span class="ribbon-title">API Tools</span>
        <span class="ribbon-module-title">Appliance Node Map</span>
    </div>

    <div class="content-wrapper flex flex-col lg:flex-row min-h-screen">
        <!-- Sidebar -->
        <aside class="w-full lg:w-80 border-r p-6 space-y-6 lg:fixed lg:h-full lg:overflow-y-auto">

            <!-- Back to Tools -->
            <div>
                <a href="index.html" class="btn-primary w-full px-4 py-2 rounded font-semibold flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                    </svg>
                    Back to API Tools
                </a>
            </div>

            <!-- API Configuration -->
            <div id="apiConfigSection" class="space-y-4">
                <!-- Collapsed Connected State -->
                <div id="connectedState" class="hidden">
                    <div class="flex items-center justify-between p-3 rounded cursor-pointer" style="background-color: var(--bg-subtle);" onclick="toggleApiConfig()">
                        <div class="flex items-center">
                            <svg class="w-5 h-5 mr-2" style="color: var(--cyan);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                            </svg>
                            <span class="font-semibold" style="color: var(--text-primary);">Connected</span>
                        </div>
                        <svg id="expandIcon" class="w-5 h-5 transition-transform" style="color: var(--text-secondary);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </div>
                    <p class="text-xs mt-2 text-center" style="color: var(--text-muted);" id="connectedInfo"></p>
                </div>

                <!-- Expanded Config Form -->
                <div id="configForm">
                    <h2 class="text-lg font-semibold" style="color: var(--text-primary);">API Configuration</h2>
                
                <!-- Deployment Type -->
                <div>
                    <label class="block text-sm font-medium mb-2" style="color: var(--text-secondary);">Deployment Type</label>
                    <select id="deploymentType" class="w-full px-3 py-2 rounded border">
                        <option value="360">RevealX 360 (Cloud)</option>
                        <option value="enterprise">RevealX Enterprise (Self-Hosted)</option>
                    </select>
                </div>

                <!-- 360 Config -->
                <div id="config360" class="space-y-3">
                    <div>
                        <label class="block text-sm font-medium mb-2" style="color: var(--text-secondary);">Tenant Name</label>
                        <input type="text" id="tenantName" placeholder="e.g., extrahop-se" class="w-full px-3 py-2 rounded border">
                        <p class="text-xs mt-1" style="color: var(--text-muted);">From: tenant.api.cloud.extrahop.com</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2" style="color: var(--text-secondary);">API ID</label>
                        <input type="text" id="apiId" class="w-full px-3 py-2 rounded border">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-2" style="color: var(--text-secondary);">API Secret</label>
                        <input type="password" id="apiSecret" class="w-full px-3 py-2 rounded border">
                    </div>
                </div>

                <!-- Enterprise Config -->
                <div id="configEnterprise" class="space-y-3" style="display: none;">
                    <div>
                        <label class="block text-sm font-medium mb-2" style="color: var(--text-secondary);">Hostname or IP</label>
                        <input type="text" id="enterpriseHost" placeholder="e.g., extrahop.company.com" class="w-full px-3 py-2 rounded border">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-2" style="color: var(--text-secondary);">API Key</label>
                        <input type="password" id="enterpriseApiKey" class="w-full px-3 py-2 rounded border">
                    </div>
                </div>

                <button id="connectBtn" class="btn-primary w-full px-4 py-2 rounded font-semibold mt-4">
                    Connect & Load Map
                </button>

                <div id="connectionStatus" class="text-sm text-center" style="display: none;">
                    <span id="statusText"></span>
                </div>
                </div> <!-- End configForm -->
            </div> <!-- End apiConfigSection -->

            <!-- Search -->
            <div id="searchSection" class="space-y-3" style="display: none;">
                <h2 class="text-lg font-semibold" style="color: var(--text-primary);">Search</h2>
                <input type="text" id="searchAppliances" placeholder="Search appliances..." class="w-full px-3 py-2 rounded border text-sm">
                <p class="text-xs" style="color: var(--text-muted);">Searches within filtered results</p>
            </div>

            <!-- Filters -->
            <div id="legend" class="space-y-3" style="display: none;">
                <h2 class="text-lg font-semibold" style="color: var(--text-primary);">Filters</h2>
                <div class="space-y-2 text-sm">
                    <label class="flex items-center gap-2 cursor-pointer hover:opacity-80">
                        <input type="checkbox" id="filter-command" checked class="w-4 h-4" style="accent-color: var(--cyan);">
                        <span>Command</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer hover:opacity-80">
                        <input type="checkbox" id="filter-discover" checked class="w-4 h-4" style="accent-color: var(--lime);">
                        <span>Discover/Sensor</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer hover:opacity-80">
                        <input type="checkbox" id="filter-trace" checked class="w-4 h-4" style="accent-color: var(--tangerine);">
                        <span>Trace/Packetstore</span>
                    </label>
                </div>
                <div class="border-t pt-3 space-y-2 text-sm" style="border-color: var(--border-color);">
                    <label class="flex items-center gap-2 cursor-pointer hover:opacity-80">
                        <input type="checkbox" id="filter-physical" checked class="w-4 h-4">
                        <span>Physical</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer hover:opacity-80">
                        <input type="checkbox" id="filter-virtual" checked class="w-4 h-4">
                        <span>Virtual/Cloud</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer hover:opacity-80">
                        <input type="checkbox" id="filter-online" checked class="w-4 h-4" style="accent-color: #10b981;">
                        <span>Online</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer hover:opacity-80">
                        <input type="checkbox" id="filter-offline" checked class="w-4 h-4" style="accent-color: #ef4444;">
                        <span>Offline</span>
                    </label>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 lg:ml-80 p-6">
            <div class="space-y-6">
                <!-- Loading State -->
                <div id="loadingState" class="text-center py-20" style="display: none;">
                    <div class="spinner mx-auto mb-4"></div>
                    <p style="color: var(--text-muted);">Loading appliances...</p>
                </div>

                <!-- Header -->
                <div id="graphHeader" class="flex items-center justify-between" style="display: none;">
                    <h2 class="text-2xl font-bold" style="color: var(--text-primary);">Appliance Topology</h2>
                    <p id="nodeCount" style="color: var(--text-muted);"></p>
                </div>
                
                <!-- Graph Container -->
                <div id="graphContainer" class="detail-panel rounded-lg p-6" style="display: none; min-height: 800px;">
                    <svg id="nodeGraph" width="100%" height="800"></svg>
                </div>

                <!-- Detail Panel -->
                <div id="detailPanel" class="detail-panel rounded-lg p-6" style="display: none;">
                    <div class="flex justify-between items-start mb-4">
                        <h3 class="text-xl font-bold" id="detailName" style="color: var(--text-primary);">Node Details</h3>
                        <button id="closeDetail" style="color: var(--text-muted);" class="hover:opacity-70">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <p class="text-xs uppercase mb-1" style="color: var(--text-muted);">Model</p>
                            <p class="font-semibold" id="detailModel" style="color: var(--text-primary);">-</p>
                        </div>
                        <div>
                            <p class="text-xs uppercase mb-1" style="color: var(--text-muted);">Platform</p>
                            <p class="font-semibold" id="detailPlatform" style="color: var(--text-primary);">-</p>
                        </div>
                        <div>
                            <p class="text-xs uppercase mb-1" style="color: var(--text-muted);">Firmware Version</p>
                            <p class="font-semibold" id="detailFirmware" style="color: var(--text-primary);">-</p>
                        </div>
                        <div>
                            <p class="text-xs uppercase mb-1" style="color: var(--text-muted);">Status</p>
                            <p class="font-semibold" id="detailStatus" style="color: var(--text-primary);">-</p>
                        </div>
                        <div class="md:col-span-2">
                            <p class="text-xs uppercase mb-1" style="color: var(--text-muted);">Product Modules</p>
                            <p class="font-semibold" id="detailModules" style="color: var(--text-primary);">-</p>
                        </div>
                    </div>
                </div>

                <!-- Welcome Screen -->
                <div id="welcomeScreen">
                    <div class="max-w-2xl mx-auto text-center py-20">
                        <h2 class="text-3xl font-bold mb-4" style="color: var(--sapphire);">Appliance Node Map</h2>
                        <p class="text-lg mb-8" style="color: var(--text-secondary);">
                            Connect to your ExtraHop instance to visualize your appliance topology.
                        </p>
                        <div class="space-y-4 text-left" style="color: var(--text-muted);">
                            <div class="flex items-start">
                                <svg class="w-6 h-6 mr-3 flex-shrink-0" style="color: var(--cyan);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                <div>
                                    <strong>Visual Topology</strong> - See Command, Discover, and Trace appliances in hierarchical layout
                                </div>
                            </div>
                            <div class="flex items-start">
                                <svg class="w-6 h-6 mr-3 flex-shrink-0" style="color: var(--cyan);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                <div>
                                    <strong>Appliance Details</strong> - Click any node to view firmware, modules, and status
                                </div>
                            </div>
                            <div class="flex items-start">
                                <svg class="w-6 h-6 mr-3 flex-shrink-0" style="color: var(--cyan);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                <div>
                                    <strong>Platform Types</strong> - Color-coded nodes show physical/virtual appliances and platform types
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Error Details Modal -->
    <div id="errorModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <h3 class="text-xl font-bold mb-4" style="color: #ef4444;">Connection Error</h3>
            <div class="mb-4">
                <p class="font-semibold mb-2" style="color: var(--text-primary);">Error Message:</p>
                <p id="errorMessage" class="mb-4 p-3 rounded" style="background-color: var(--bg-subtle); color: var(--text-secondary);"></p>
            </div>
            <div class="mb-4">
                <button id="toggleErrorDetails" class="btn-secondary px-4 py-2 rounded font-semibold mb-3">
                    Show Technical Details
                </button>
                <div id="errorDetails" style="display: none;">
                    <div class="mb-3">
                        <p class="font-semibold mb-1 text-sm" style="color: var(--text-secondary);">Request URL:</p>
                        <pre id="errorUrl" class="p-3 rounded text-xs overflow-x-auto" style="background-color: var(--bg-subtle); color: var(--text-muted);"></pre>
                    </div>
                    <div class="mb-3">
                        <p class="font-semibold mb-1 text-sm" style="color: var(--text-secondary);">Request Headers:</p>
                        <pre id="errorHeaders" class="p-3 rounded text-xs overflow-x-auto" style="background-color: var(--bg-subtle); color: var(--text-muted);"></pre>
                    </div>
                    <div class="mb-3">
                        <p class="font-semibold mb-1 text-sm" style="color: var(--text-secondary);">Request Body:</p>
                        <pre id="errorBody" class="p-3 rounded text-xs overflow-x-auto" style="background-color: var(--bg-subtle); color: var(--text-muted);"></pre>
                    </div>
                    <div class="mb-3">
                        <p class="font-semibold mb-1 text-sm" style="color: var(--text-secondary);">Status:</p>
                        <pre id="errorStatus" class="p-3 rounded text-xs" style="background-color: var(--bg-subtle); color: var(--text-muted);"></pre>
                    </div>
                    <div class="mb-3">
                        <p class="font-semibold mb-1 text-sm" style="color: var(--text-secondary);">Response:</p>
                        <pre id="errorResponse" class="p-3 rounded text-xs overflow-x-auto" style="background-color: var(--bg-subtle); color: var(--text-muted);"></pre>
                    </div>
                </div>
            </div>
            <button id="closeErrorModal" class="btn-primary w-full px-4 py-2 rounded font-semibold">
                Close
            </button>
        </div>
    </div>

    <script>
        // Global State
        const state = {
            apiConfig: null,
            connected: false,
            appliances: [],
            catalogData: []
        };

        // Configuration - Lambda proxy URL (360 only)
        const LAMBDA_PROXY_URL = 'https://mdpg23urni.execute-api.us-east-2.amazonaws.com/default/extrahop-api-wrapper-proxy';

        // Platform color mapping - simplified
        const platformColors = {
            'command': '#00aaef',           // Cyan
            'packet_sensor': '#dae343',     // Lime
            'discover': '#dae343',          // Lime
            'packetstore': '#f05918',       // Tangerine
            'trace': '#f05918',             // Tangerine
            'multifunction_sensor': '#dae343', // Lime
            'all_in_one': '#dae343'         // Lime
        };

        // Active filters - all checked by default
        const filters = {
            command: true,
            discover: true,
            trace: true,
            physical: true,
            virtual: true,
            offline: true,
            online: true
        };

        let searchTerm = '';

        // API Client (matching index.html pattern)
        class ExtraHopAPI {
            constructor(config) {
                this.config = config;
                this.proxyUrl = LAMBDA_PROXY_URL;
                
                if (config.type === 'enterprise') {
                    this.baseUrl = `https://${config.host}/api/v1`;
                }
            }

            async authenticate() {
                if (this.config.type === '360') {
                    const proxyRequest = {
                        deploymentType: '360',
                        tenant: this.config.tenant,
                        apiId: this.config.apiId,
                        apiSecret: this.config.apiSecret,
                        method: 'POST',
                        endpoint: '/oauth2/token'
                    };

                    try {
                        const response = await fetch(this.proxyUrl, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(proxyRequest)
                        });

                        const responseText = await response.text();
                        let responseData;
                        try {
                            responseData = JSON.parse(responseText);
                        } catch (e) {
                            responseData = responseText;
                        }

                        if (!response.ok) {
                            const errorDetails = {
                                url: this.proxyUrl,
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(proxyRequest, null, 2),
                                status: `${response.status} ${response.statusText}`,
                                response: responseData
                            };
                            
                            let errorMessage = 'Authentication failed. ';
                            if (response.status === 401) {
                                errorMessage += 'Invalid API ID or Secret (401 Unauthorized).';
                            } else if (response.status === 403) {
                                errorMessage += 'Access forbidden (403 Forbidden). Check API permissions.';
                            } else if (response.status === 404) {
                                errorMessage += 'Endpoint not found (404). Check tenant name.';
                            } else if (response.status === 400) {
                                errorMessage += `Bad request: ${responseData.error || 'Check configuration'}`;
                            } else {
                                errorMessage += `Server returned ${response.status} ${response.statusText}.`;
                            }

                            showErrorModal(errorMessage, errorDetails);
                            throw new Error(errorMessage);
                        }

                        this.accessToken = responseData.access_token;
                        sessionStorage.setItem('eh_access_token', responseData.access_token);
                        return true;
                    } catch (error) {
                        if (error.message.includes('Authentication failed')) {
                            throw error;
                        }
                        const errorDetails = {
                            url: this.proxyUrl,
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(proxyRequest, null, 2),
                            status: 'Network Error',
                            response: error.message
                        };
                        const errorMessage = `Network error: ${error.message}. Check Lambda proxy URL: ${this.proxyUrl}`;
                        showErrorModal(errorMessage, errorDetails);
                        throw new Error(errorMessage);
                    }
                } else {
                    // Enterprise: Direct API call
                    const requestUrl = `${this.baseUrl}/extrahop`;
                    const requestHeaders = {
                        'Authorization': `ExtraHop apikey=${this.config.apiKey}`,
                        'Accept': 'application/json'
                    };

                    try {
                        const response = await fetch(requestUrl, {
                            headers: requestHeaders
                        });

                        const responseText = await response.text();
                        let responseData;
                        try {
                            responseData = JSON.parse(responseText);
                        } catch (e) {
                            responseData = responseText;
                        }

                        if (!response.ok) {
                            const errorDetails = {
                                url: requestUrl,
                                headers: requestHeaders,
                                body: 'N/A',
                                status: `${response.status} ${response.statusText}`,
                                response: responseData
                            };
                            
                            let errorMessage = 'Authentication failed. ';
                            if (response.status === 401) {
                                errorMessage += 'Invalid API key (401 Unauthorized).';
                            } else if (response.status === 403) {
                                errorMessage += 'Access forbidden (403 Forbidden). Check API key permissions.';
                            } else if (response.status === 404) {
                                errorMessage += 'Endpoint not found (404). Check hostname.';
                            } else if (response.status === 400) {
                                errorMessage += `Bad request: ${responseData.error_message || 'Check configuration'}`;
                            } else {
                                errorMessage += `Server returned ${response.status} ${response.statusText}.`;
                            }

                            showErrorModal(errorMessage, errorDetails);
                            throw new Error(errorMessage);
                        }

                        return true;
                    } catch (error) {
                        if (error.message.includes('Authentication failed')) {
                            throw error;
                        }
                        const errorDetails = {
                            url: requestUrl,
                            headers: requestHeaders,
                            body: 'N/A',
                            status: 'Network Error',
                            response: error.message
                        };
                        
                        let errorMessage = `Network error: ${error.message}. `;
                        if (error.message.includes('Failed to fetch')) {
                            errorMessage += 'This is likely a CORS issue. For Enterprise instances, you need to either:\n' +
                                '1. Enable CORS on your ExtraHop appliance for this domain\n' +
                                '2. Use a browser extension version of this tool\n' +
                                '3. Run locally with CORS disabled for testing';
                        }
                        
                        showErrorModal(errorMessage, errorDetails);
                        throw new Error(errorMessage);
                    }
                }
            }

            async request(endpoint, options = {}) {
                if (!endpoint.startsWith('/api/v1') && !endpoint.startsWith('/oauth2')) {
                    endpoint = '/api/v1' + endpoint;
                }

                const makeRequest = async () => {
                    if (this.config.type === '360') {
                        // 360: Use Lambda proxy
                        const proxyRequest = {
                            deploymentType: '360',
                            tenant: this.config.tenant,
                            accessToken: this.accessToken,
                            method: options.method || 'GET',
                            endpoint: endpoint
                        };

                        if (options.body) {
                            proxyRequest.requestBody = JSON.parse(options.body);
                        }

                        const response = await fetch(this.proxyUrl, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(proxyRequest)
                        });

                        if (response.status < 200 || response.status >= 300) {
                            const error = await response.text();
                            let errorMessage;
                            try {
                                const errorJson = JSON.parse(error);
                                errorMessage = errorJson.error_message || error;
                            } catch (e) {
                                errorMessage = error;
                            }
                            throw new Error(`API Error: ${response.status} - ${errorMessage}`);
                        }

                        if (response.status === 204) {
                            return {};
                        }

                        const text = await response.text();
                        return text ? JSON.parse(text) : {};
                    } else {
                        // Enterprise: Direct API call
                        const url = `${this.baseUrl}${endpoint.startsWith('/api/v1') ? endpoint.substring(7) : endpoint}`;
                        
                        const response = await fetch(url, {
                            method: options.method || 'GET',
                            headers: {
                                'Authorization': `ExtraHop apikey=${this.config.apiKey}`,
                                'Content-Type': 'application/json',
                                'Accept': 'application/json'
                            },
                            body: options.body
                        });

                        if (response.status < 200 || response.status >= 300) {
                            const error = await response.text();
                            let errorMessage;
                            try {
                                const errorJson = JSON.parse(error);
                                errorMessage = errorJson.error_message || error;
                            } catch (e) {
                                errorMessage = error;
                            }
                            throw new Error(`API Error: ${response.status} - ${errorMessage}`);
                        }

                        if (response.status === 204) {
                            return {};
                        }

                        const text = await response.text();
                        return text ? JSON.parse(text) : {};
                    }
                };

                // Try request, if 401 and 360, refresh token and retry
                try {
                    return await makeRequest();
                } catch (error) {
                    if (error.message.includes('401') && this.config.type === '360') {
                        console.log('Token expired, attempting refresh...');
                        
                        const tempApi = new ExtraHopAPI(this.config);
                        await tempApi.authenticate();
                        this.accessToken = tempApi.accessToken;
                        
                        console.log('Token refreshed, retrying request...');
                        return await makeRequest();
                    }
                    throw error;
                }
            }

            async getAppliances() {
                return this.request('/appliances');
            }
        }

        // UI Functions
        function showStatus(message, isError = false) {
            const statusDiv = document.getElementById('connectionStatus');
            const statusText = document.getElementById('statusText');
            statusDiv.style.display = 'block';
            statusText.textContent = message;
            statusText.style.color = isError ? '#ef4444' : 'var(--cyan)';
        }

        function toggleApiConfig() {
            const configForm = document.getElementById('configForm');
            const expandIcon = document.getElementById('expandIcon');
            
            if (configForm.style.display === 'none') {
                configForm.style.display = 'block';
                expandIcon.style.transform = 'rotate(0deg)';
            } else {
                configForm.style.display = 'none';
                expandIcon.style.transform = 'rotate(-90deg)';
            }
        }

        function showConnectedState() {
            const connectedState = document.getElementById('connectedState');
            const configForm = document.getElementById('configForm');
            const connectedInfo = document.getElementById('connectedInfo');
            
            connectedState.classList.remove('hidden');
            configForm.style.display = 'none';
            
            if (state.apiConfig.type === '360') {
                connectedInfo.textContent = `RevealX 360: ${state.apiConfig.tenant}`;
            } else {
                connectedInfo.textContent = `RevealX Enterprise: ${state.apiConfig.host}`;
            }
            
            document.getElementById('expandIcon').style.transform = 'rotate(-90deg)';
        }

        function showErrorModal(message, details) {
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorUrl').textContent = details.url || 'N/A';
            document.getElementById('errorHeaders').textContent = JSON.stringify(details.headers || {}, null, 2);
            document.getElementById('errorBody').textContent = details.body || 'N/A';
            document.getElementById('errorStatus').textContent = details.status || 'N/A';
            document.getElementById('errorResponse').textContent = typeof details.response === 'object' 
                ? JSON.stringify(details.response, null, 2) 
                : details.response || 'N/A';
            
            document.getElementById('errorDetails').style.display = 'none';
            document.getElementById('toggleErrorDetails').textContent = 'Show Technical Details';
            showModal('errorModal');
        }

        function showModal(modalId) {
            document.getElementById(modalId).classList.add('show');
        }

        function hideModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        // Load catalog data
        async function loadCatalog() {
            try {
                const response = await fetch('catalog_eh.json');
                state.catalogData = await response.json();
            } catch (error) {
                console.error('Could not load catalog:', error);
            }
        }

        // Get catalog info for a model
        function getCatalogInfo(licensePlatform) {
            if (!licensePlatform) return null;
            
            let modelName = licensePlatform.replace(/_TRACE$/, '');
            return state.catalogData.find(item => item.name === modelName || item.name === licensePlatform);
        }

        // Determine platform type and characteristics
        function getNodeInfo(appliance) {
            const catalogInfo = getCatalogInfo(appliance.license_platform);
            
            let platform = appliance.platform;
            let isVirtual = false;
            let hasIntegratedTrace = false;
            
            if (catalogInfo) {
                platform = catalogInfo.platform;
                isVirtual = !catalogInfo.is_physical;
                
                if (appliance.license_platform && appliance.license_platform.includes('_TRACE')) {
                    hasIntegratedTrace = true;
                }
            } else {
                // Fallback: check if model name has V before underscore or at end
                // Examples: EDA1100V, EDA1100V_TRACE, ETA6150v
                if (appliance.license_platform) {
                    const model = appliance.license_platform;
                    // Check for V/v right before underscore or at the end of string
                    isVirtual = /v(_|$)/i.test(model);
                }
            }
            
            const isOffline = appliance.status_message && appliance.status_message.toLowerCase() !== 'online';
            
            return { platform, isVirtual, hasIntegratedTrace, isOffline };
        }

        // Handle connect and load
        async function handleConnect() {
            const connectBtn = document.getElementById('connectBtn');
            const deploymentType = document.getElementById('deploymentType').value;

            try {
                connectBtn.disabled = true;
                connectBtn.textContent = 'Connecting...';

                let config;
                if (deploymentType === '360') {
                    config = {
                        type: '360',
                        tenant: document.getElementById('tenantName').value.trim(),
                        apiId: document.getElementById('apiId').value.trim(),
                        apiSecret: document.getElementById('apiSecret').value.trim()
                    };

                    if (!config.tenant || !config.apiId || !config.apiSecret) {
                        throw new Error('Please fill in all fields');
                    }
                } else {
                    config = {
                        type: 'enterprise',
                        host: document.getElementById('enterpriseHost').value.trim(),
                        apiKey: document.getElementById('enterpriseApiKey').value.trim()
                    };

                    if (!config.host || !config.apiKey) {
                        throw new Error('Please fill in all fields');
                    }
                }

                const api = new ExtraHopAPI(config);
                await api.authenticate();

                state.apiConfig = config;
                state.connected = true;
                sessionStorage.setItem('eh_config', JSON.stringify(config));
                window.apiClient = api;

                showStatus('✓ Connected successfully', false);
                showConnectedState();
                
                // Load appliances
                await loadAppliances();

            } catch (error) {
                showStatus('✗ ' + error.message, true);
                connectBtn.textContent = 'Connect & Load Map';
                connectBtn.disabled = false;
            }
        }

        async function loadAppliances() {
            const connectBtn = document.getElementById('connectBtn');
            
            try {
                connectBtn.textContent = 'Loading appliances...';
                document.getElementById('welcomeScreen').style.display = 'none';
                document.getElementById('loadingState').style.display = 'block';

                state.appliances = await window.apiClient.getAppliances();
                
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('graphHeader').style.display = 'flex';
                document.getElementById('graphContainer').style.display = 'block';
                document.getElementById('legend').style.display = 'block';
                document.getElementById('searchSection').style.display = 'block';
                document.getElementById('nodeCount').textContent = `${state.appliances.length} appliances`;
                
                connectBtn.textContent = 'Connected';
                setTimeout(() => {
                    connectBtn.textContent = 'Reconnect';
                    connectBtn.disabled = false;
                }, 2000);

                renderGraph();
            } catch (error) {
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('welcomeScreen').style.display = 'block';
                showStatus('✗ Error loading appliances: ' + error.message, true);
                connectBtn.textContent = 'Connect & Load Map';
                connectBtn.disabled = false;
            }
        }

        // Helper function to check if appliance matches search
        function matchesSearch(appliance) {
            if (!searchTerm) return true;
            
            const term = searchTerm.toLowerCase();
            const searchableFields = [
                appliance.display_name,
                appliance.hostname,
                appliance.nickname,
                appliance.license_platform,
                appliance.platform,
                appliance.firmware_version,
                appliance.status_message,
                appliance.uuid,
                appliance.id?.toString(),
                ...(appliance.product_modules || []),
                ...(appliance.licensed_modules || [])
            ];
            
            return searchableFields.some(field => 
                field && field.toString().toLowerCase().includes(term)
            );
        }

        // Render the graph
        function renderGraph() {
            const svg = d3.select('#nodeGraph');
            const container = document.getElementById('graphContainer');
            const width = container.clientWidth - 48;
            const height = 800; // Increased height for 2 rows
            
            svg.attr('width', width).attr('height', height);
            svg.selectAll('*').remove();

            if (state.appliances.length === 0) {
                svg.append('text')
                    .attr('x', width / 2)
                    .attr('y', height / 2)
                    .attr('text-anchor', 'middle')
                    .attr('fill', '#9ca3af')
                    .text('No appliances to display');
                return;
            }

            // Create zoom behavior
            const g = svg.append('g');
            const zoom = d3.zoom()
                .scaleExtent([0.5, 2])
                .on('zoom', (event) => {
                    g.attr('transform', event.transform);
                });
            svg.call(zoom);

            // Add reset zoom button info
            svg.append('text')
                .attr('x', 10)
                .attr('y', 20)
                .attr('fill', '#9ca3af')
                .attr('font-size', '12')
                .text('Scroll to zoom, drag to pan');

            // Filter appliances based on active filters
            const filteredAppliances = state.appliances.filter(a => {
                const info = getNodeInfo(a);
                
                // First apply checkbox filters
                // Platform type filters
                if (info.platform === 'command' && !filters.command) return false;
                
                if ((info.platform === 'packet_sensor' || info.platform === 'discover' || 
                     info.platform === 'multifunction_sensor' || info.platform === 'all_in_one') && !filters.discover) {
                    return false;
                }
                
                if ((info.platform === 'packetstore' || info.platform === 'trace') && 
                    !info.hasIntegratedTrace && !filters.trace) {
                    return false;
                }
                
                // Physical/Virtual filters
                if (info.isVirtual && !filters.virtual) return false;
                if (!info.isVirtual && !filters.physical) return false;
                
                // Online/Offline filters
                if (info.isOffline && !filters.offline) return false;
                if (!info.isOffline && !filters.online) return false;
                
                // Finally apply search filter within the checkbox-filtered results
                if (!matchesSearch(a)) return false;
                
                return true;
            });

            // Group appliances by type
            const commandAppliances = filteredAppliances.filter(a => {
                const info = getNodeInfo(a);
                return info.platform === 'command';
            });
            
            const discoverAppliances = filteredAppliances.filter(a => {
                const info = getNodeInfo(a);
                return info.platform === 'packet_sensor' || info.platform === 'discover' || 
                       info.platform === 'multifunction_sensor' || info.platform === 'all_in_one';
            });
            
            const traceAppliances = filteredAppliances.filter(a => {
                const info = getNodeInfo(a);
                return (info.platform === 'packetstore' || info.platform === 'trace') && 
                       !info.hasIntegratedTrace;
            });

            // Layout parameters
            const nodeWidth = 180;
            const nodeHeight = 60;
            const verticalGap = 100;
            const horizontalGap = 20;
            const rowGap = 80;
            const nodesPerRow = Math.max(5, Math.ceil(Math.max(commandAppliances.length, discoverAppliances.length, traceAppliances.length) / 2));

            // Calculate positions for each group with 2 rows max
            function calculatePositions(appliances, startY) {
                const positions = [];
                const itemsInFirstRow = Math.min(nodesPerRow, appliances.length);
                const itemsInSecondRow = Math.max(0, appliances.length - nodesPerRow);
                
                // First row
                const firstRowWidth = itemsInFirstRow * (nodeWidth + horizontalGap) - horizontalGap;
                const firstRowStartX = (width - firstRowWidth) / 2;
                
                appliances.slice(0, nodesPerRow).forEach((app, i) => {
                    positions.push({
                        appliance: app,
                        x: firstRowStartX + i * (nodeWidth + horizontalGap),
                        y: startY
                    });
                });
                
                // Second row if needed
                if (itemsInSecondRow > 0) {
                    const secondRowWidth = itemsInSecondRow * (nodeWidth + horizontalGap) - horizontalGap;
                    const secondRowStartX = (width - secondRowWidth) / 2;
                    
                    appliances.slice(nodesPerRow).forEach((app, i) => {
                        positions.push({
                            appliance: app,
                            x: secondRowStartX + i * (nodeWidth + horizontalGap),
                            y: startY + rowGap
                        });
                    });
                }
                
                return positions;
            }

            const commandY = 60;
            const discoverY = commandY + verticalGap + (commandAppliances.length > nodesPerRow ? rowGap : 0);
            const traceY = discoverY + verticalGap + (discoverAppliances.length > nodesPerRow ? rowGap : 0);

            const commandPositions = calculatePositions(commandAppliances, commandY);
            const discoverPositions = calculatePositions(discoverAppliances, discoverY);
            const tracePositions = calculatePositions(traceAppliances, traceY);

            // Draw links from command to all other appliances
            commandPositions.forEach(cmd => {
                const cmdX = cmd.x + nodeWidth / 2;
                const cmdY = cmd.y + nodeHeight;
                
                discoverPositions.forEach(dis => {
                    const disX = dis.x + nodeWidth / 2;
                    const disY = dis.y;
                    
                    g.append('path')
                        .attr('class', 'link')
                        .attr('d', `M ${cmdX} ${cmdY} L ${disX} ${disY}`);
                });
                
                tracePositions.forEach(trc => {
                    const trcX = trc.x + nodeWidth / 2;
                    const trcY = trc.y;
                    
                    g.append('path')
                        .attr('class', 'link')
                        .attr('d', `M ${cmdX} ${cmdY} L ${trcX} ${trcY}`);
                });
            });

            // Draw nodes
            function drawNodes(positions) {
                positions.forEach(pos => {
                    const appliance = pos.appliance;
                    const x = pos.x;
                    const y = pos.y;
                    const info = getNodeInfo(appliance);
                    const color = platformColors[info.platform] || '#6b7280';

                    const nodeGroup = g.append('g')
                        .attr('class', 'node-group')
                        .attr('data-id', appliance.id);

                    nodeGroup.append('rect')
                        .attr('class', `node-rect ${info.isVirtual ? 'virtual' : ''}`)
                        .attr('x', x)
                        .attr('y', y)
                        .attr('width', nodeWidth)
                        .attr('height', nodeHeight)
                        .attr('rx', 8)
                        .attr('fill', color)
                        .attr('stroke', color)
                        .attr('fill-opacity', 0.2);

                    nodeGroup.append('text')
                        .attr('class', 'node-text')
                        .attr('x', x + nodeWidth / 2)
                        .attr('y', y + 22)
                        .attr('text-anchor', 'middle')
                        .attr('fill', 'currentColor')
                        .attr('font-weight', '600')
                        .attr('font-size', '14')
                        .text(appliance.display_name || appliance.hostname || `Appliance ${appliance.id}`);

                    nodeGroup.append('text')
                        .attr('class', 'node-text')
                        .attr('x', x + nodeWidth / 2)
                        .attr('y', y + 40)
                        .attr('text-anchor', 'middle')
                        .attr('fill', 'currentColor')
                        .attr('font-size', '11')
                        .attr('opacity', 0.7)
                        .text(appliance.license_platform || appliance.platform);

                    if (info.isOffline) {
                        nodeGroup.append('circle')
                            .attr('class', 'offline-indicator')
                            .attr('cx', x + nodeWidth - 10)
                            .attr('cy', y + 10)
                            .attr('r', 6);
                    }

                    if (info.hasIntegratedTrace) {
                        nodeGroup.append('rect')
                            .attr('x', x + 5)
                            .attr('y', y + 5)
                            .attr('width', 30)
                            .attr('height', 16)
                            .attr('rx', 4)
                            .attr('fill', platformColors.trace)
                            .attr('opacity', 0.8);
                        
                        nodeGroup.append('text')
                            .attr('class', 'node-text')
                            .attr('x', x + 20)
                            .attr('y', y + 16)
                            .attr('text-anchor', 'middle')
                            .attr('fill', 'white')
                            .attr('font-size', '9')
                            .attr('font-weight', '600')
                            .text('PCAP');
                    }

                    nodeGroup.on('click', () => showNodeDetails(appliance));
                });
            }

            drawNodes(commandPositions);
            drawNodes(discoverPositions);
            drawNodes(tracePositions);

            // Update count to show filtered vs total
            const totalCount = state.appliances.length;
            const filteredCount = filteredAppliances.length;
            if (filteredCount < totalCount) {
                document.getElementById('nodeCount').textContent = `${filteredCount} of ${totalCount} appliances`;
            } else {
                document.getElementById('nodeCount').textContent = `${totalCount} appliances`;
            }
        }

        // Show node details
        function showNodeDetails(appliance) {
            const panel = document.getElementById('detailPanel');
            
            document.getElementById('detailName').textContent = appliance.display_name || appliance.hostname || `Appliance ${appliance.id}`;
            document.getElementById('detailModel').textContent = appliance.license_platform || 'Unknown';
            document.getElementById('detailPlatform').textContent = appliance.platform || 'Unknown';
            document.getElementById('detailFirmware').textContent = appliance.firmware_version || 'Unknown';
            document.getElementById('detailStatus').textContent = appliance.status_message || 'Unknown';
            
            const modules = appliance.product_modules && appliance.product_modules.length > 0 
                ? appliance.product_modules.join(', ') 
                : 'None';
            document.getElementById('detailModules').textContent = modules;
            
            panel.style.display = 'block';
            panel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        // Event Listeners
        document.getElementById('deploymentType').addEventListener('change', (e) => {
            const is360 = e.target.value === '360';
            document.getElementById('config360').style.display = is360 ? 'block' : 'none';
            document.getElementById('configEnterprise').style.display = is360 ? 'none' : 'block';
        });

        document.getElementById('connectBtn').addEventListener('click', handleConnect);
        document.getElementById('closeDetail').addEventListener('click', () => {
            document.getElementById('detailPanel').style.display = 'none';
        });

        // Filter checkboxes
        document.getElementById('filter-command').addEventListener('change', (e) => {
            filters.command = e.target.checked;
            renderGraph();
        });
        document.getElementById('filter-discover').addEventListener('change', (e) => {
            filters.discover = e.target.checked;
            renderGraph();
        });
        document.getElementById('filter-trace').addEventListener('change', (e) => {
            filters.trace = e.target.checked;
            renderGraph();
        });
        document.getElementById('filter-physical').addEventListener('change', (e) => {
            filters.physical = e.target.checked;
            renderGraph();
        });
        document.getElementById('filter-virtual').addEventListener('change', (e) => {
            filters.virtual = e.target.checked;
            renderGraph();
        });
        document.getElementById('filter-online').addEventListener('change', (e) => {
            filters.online = e.target.checked;
            renderGraph();
        });
        document.getElementById('filter-offline').addEventListener('change', (e) => {
            filters.offline = e.target.checked;
            renderGraph();
        });

        // Search input
        document.getElementById('searchAppliances').addEventListener('input', (e) => {
            searchTerm = e.target.value.trim();
            renderGraph();
        });

        document.getElementById('closeErrorModal').addEventListener('click', () => hideModal('errorModal'));
        document.getElementById('toggleErrorDetails').addEventListener('click', function() {
            const detailsDiv = document.getElementById('errorDetails');
            if (detailsDiv.style.display === 'none') {
                detailsDiv.style.display = 'block';
                this.textContent = 'Hide Technical Details';
            } else {
                detailsDiv.style.display = 'none';
                this.textContent = 'Show Technical Details';
            }
        });

        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('show');
                }
            });
        });

        window.addEventListener('resize', () => {
            if (state.appliances.length > 0) {
                renderGraph();
            }
        });

        // Load saved config and catalog on page load
        window.addEventListener('DOMContentLoaded', () => {
            const savedConfig = sessionStorage.getItem('eh_config');
            if (savedConfig) {
                const config = JSON.parse(savedConfig);
                if (config.type === '360') {
                    document.getElementById('deploymentType').value = '360';
                    document.getElementById('tenantName').value = config.tenant || '';
                    document.getElementById('apiId').value = config.apiId || '';
                    document.getElementById('apiSecret').value = config.apiSecret || '';
                } else {
                    document.getElementById('deploymentType').value = 'enterprise';
                    document.getElementById('enterpriseHost').value = config.host || '';
                    document.getElementById('enterpriseApiKey').value = config.apiKey || '';
                    document.getElementById('config360').style.display = 'none';
                    document.getElementById('configEnterprise').style.display = 'block';
                }
            }
            loadCatalog();
        });
    </script>
</body>
</html>
