<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ExtraHop API Tools</title>
    <link rel="icon" href="favicon.png" type="image/png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Source+Sans+3:wght@400;600;700&display=swap" rel="stylesheet">
    
    <!-- Load modular CSS -->
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <!-- TOP RIBBON -->
    <div class="top-ribbon">
        <img src="eh_logo.png" alt="ExtraHop" class="ribbon-logo">
        <span class="ribbon-title">API Tools</span>
        <span id="ribbonModuleTitle" class="ribbon-module-title"></span>
    </div>

    <!-- MAIN CONTENT -->
    <div class="content-wrapper flex flex-col lg:flex-row min-h-screen">
        <!-- SIDEBAR -->
        <aside class="w-full lg:w-80 border-r p-6 space-y-6 lg:fixed lg:h-full lg:overflow-y-auto">
            <!-- API Configuration Section -->
            <div id="apiConfigSection" class="space-y-4">
                <!-- Connected State (Hidden Initially) -->
                <div id="connectedState" class="hidden">
                    <div class="flex items-center justify-between p-3 rounded cursor-pointer" style="background-color: var(--bg-subtle);" onclick="toggleApiConfig()">
                        <div class="flex items-center">
                            <svg class="w-5 h-5 mr-2" style="color: var(--cyan);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <span class="font-semibold" style="color: var(--text-primary);">Connected</span>
                        </div>
                        <svg id="expandIcon" class="w-5 h-5 transition-transform" style="color: var(--text-secondary);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </div>
                    <p class="text-xs mt-2 text-center" style="color: var(--text-muted);" id="connectedInfo"></p>
                </div>

                <!-- Configuration Form -->
                <div id="configForm">
                    <h2 class="text-lg font-semibold" style="color: var(--text-primary);">API Configuration</h2>
                    
                    <!-- Deployment Type -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-2" style="color: var(--text-secondary);">Deployment Type</label>
                        <select id="deploymentType" class="w-full px-3 py-2 rounded border">
                            <option value="360">RevealX 360 (Cloud)</option>
                            <option value="enterprise">RevealX Enterprise (On-Premises)</option>
                        </select>
                    </div>

                    <!-- 360 Configuration -->
                    <div id="config360" class="space-y-3">
                        <div class="mb-4">
                            <label class="block text-sm font-medium mb-2" style="color: var(--text-secondary);">Tenant Name</label>
                            <input type="text" id="tenantName" placeholder="e.g., extrahop-se" class="w-full px-3 py-2 rounded border">
                            <p class="text-xs mt-1" style="color: var(--text-muted);">From: tenant.api.cloud.extrahop.com</p>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium mb-2" style="color: var(--text-secondary);">API ID</label>
                            <input type="text" id="apiId" class="w-full px-3 py-2 rounded border">
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium mb-2" style="color: var(--text-secondary);">API Secret</label>
                            <input type="password" id="apiSecret" class="w-full px-3 py-2 rounded border">
                        </div>
                        <div class="mb-4">
                            <label class="flex items-center cursor-pointer">
                                <input type="checkbox" id="useAwsProxy" checked class="mr-2">
                                <span class="text-sm" style="color: var(--text-secondary);">Use AWS Proxy</span>
                            </label>
                            <p class="text-xs mt-1 ml-6" style="color: var(--text-muted);">Unchecking requires CORS configuration on tenant</p>
                        </div>
                    </div>

                    <!-- Enterprise Configuration -->
                    <div id="configEnterprise" class="space-y-3" style="display: none;">
                        <div class="mb-4">
                            <label class="block text-sm font-medium mb-2" style="color: var(--text-secondary);">Hostname or IP</label>
                            <input type="text" id="enterpriseHost" placeholder="e.g., extrahop.company.com" class="w-full px-3 py-2 rounded border">
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium mb-2" style="color: var(--text-secondary);">API Key</label>
                            <input type="password" id="enterpriseApiKey" class="w-full px-3 py-2 rounded border">
                        </div>
                        <div class="mb-4 p-3 rounded" style="background-color: var(--bg-subtle);">
                            <p class="text-xs mb-2" style="color: var(--text-muted);">
                                <strong>Note:</strong> Web-based API requests require CORS to be configured on your RevealX Enterprise appliance.
                            </p>
                            <a href="https://docs.extrahop.com/current/rest-api-guide/#:~:text=Configure%20cross%2Dorigin%20resource%20sharing%20(CORS)" 
                               target="_blank" 
                               rel="noopener noreferrer" 
                               class="text-xs flex items-center gap-1" 
                               style="color: var(--cyan);">
                                <span>Configure CORS on RevealX Enterprise</span>
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                                </svg>
                            </a>
                        </div>
                    </div>

                    <button id="connectBtn" class="btn-primary w-full py-2 px-4 rounded font-semibold">
                        Connect
                    </button>
                </div>
            </div>

            <!-- Connection Status -->
            <div id="connectionStatus" style="display: none;">
                <div class="p-3 rounded" style="background-color: var(--bg-card); border: 1px solid var(--border-color);">
                    <p id="statusText" class="text-sm font-medium"></p>
                </div>
            </div>

            <!-- Module Selection -->
            <div id="moduleSelection" style="display: none;">
                <h2 class="text-lg font-semibold mb-4" style="color: var(--text-primary);">Tools</h2>
                <nav class="space-y-2">
                    <button class="module-btn w-full text-left px-4 py-3 rounded" data-module="dashboards">
                        <div class="flex items-center">
                            <svg class="w-5 h-5 mr-3" style="color: var(--sapphire);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path>
                            </svg>
                            <div>
                                <div class="font-semibold">Dashboard Manager</div>
                                <div class="text-xs" style="color: var(--text-muted);">Manage dashboards at scale</div>
                            </div>
                        </div>
                    </button>
                    
                    <button class="module-btn w-full text-left px-4 py-3 rounded" data-module="crs-usage">
                        <div class="flex items-center">
                            <svg class="w-5 h-5 mr-3" style="color: var(--plum);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                            </svg>
                            <div>
                                <div class="font-semibold">Records Report</div>
                                <div class="text-xs" style="color: var(--text-muted);">CRS usage analysis</div>
                            </div>
                        </div>
                    </button>

                    <button class="module-btn w-full text-left px-4 py-3 rounded" data-module="localities">
                        <div class="flex items-center">
                            <svg class="w-5 h-5 mr-3" style="color: var(--tangerine);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"></path>
                            </svg>
                            <div>
                                <div class="font-semibold">Network Localities</div>
                                <div class="text-xs" style="color: var(--text-muted);">Manage network locality definitions</div>
                            </div>
                        </div>
                    </button>

                    <button class="module-btn w-full text-left px-4 py-3 rounded" data-module="audit-logs">
                        <div class="flex items-center">
                            <svg class="w-5 h-5 mr-3" style="color: var(--magenta);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            <div>
                                <div class="font-semibold">Audit Logs</div>
                                <div class="text-xs" style="color: var(--text-muted);">Analyze audit log data</div>
                            </div>
                        </div>
                    </button>

                    <button class="module-btn w-full text-left px-4 py-3 rounded" data-module="nodemap">
                        <div class="flex items-center">
                            <svg class="w-5 h-5 mr-3" style="color: var(--tangerine);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <circle cx="6" cy="6" r="2" stroke-width="2"></circle>
                                <circle cx="18" cy="6" r="2" stroke-width="2"></circle>
                                <circle cx="12" cy="18" r="2" stroke-width="2"></circle>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7.5 7.5L10.5 16.5M16.5 7.5L13.5 16.5"></path>
                            </svg>
                            <div>
                                <div class="font-semibold">Connected Appliances</div>
                                <div class="text-xs" style="color: var(--text-muted);">Visualize appliance topology</div>
                            </div>
                        </div>
                    </button>
                </nav>

                <!-- Other Tools (external links) -->
                <div class="mt-6">
                    <button id="otherToolsToggle" class="w-full flex items-center justify-between px-4 py-2 rounded text-sm" style="color: var(--text-secondary); background-color: transparent;">
                        <span class="font-semibold">Other Tools</span>
                        <span id="otherToolsCaret" class="text-xs">â–¶</span>
                    </button>
                    <div id="otherToolsContainer" class="mt-2 space-y-2" style="display: none;">
                        <button id="productCatalogBtn" class="w-full text-left px-4 py-2 rounded border text-sm" style="border-color: var(--border-color);">
                            Product Catalog
                        </button>
                        <button id="restApiGuideBtn" class="w-full text-left px-4 py-2 rounded border text-sm" style="border-color: var(--border-color);">
                            REST API Guide
                        </button>
                    </div>
                </div>
            </div>
        </aside>

        <!-- MAIN CONTENT AREA -->
        <main class="flex-1 lg:ml-80 min-h-screen p-6" style="background-color: var(--bg-primary);">
            <!-- Welcome Screen -->
            <div id="welcomeScreen" class="flex items-center justify-center h-full">
                <div class="text-center p-8">
                    <img src="eh_logo.png" alt="ExtraHop" class="mx-auto mb-6 h-16">
                    <h1 class="text-3xl font-bold mb-4" style="color: var(--sapphire);">ExtraHop API Tools</h1>
                    <p class="text-lg mb-6" style="color: var(--text-secondary);">Connect to your ExtraHop deployment to get started</p>
                    <div class="max-w-md mx-auto" style="color: var(--text-muted);">
                        <p class="text-sm">This tool provides a web-based interface for managing ExtraHop resources via API. Configure your connection in the sidebar to begin.</p>
                    </div>
                </div>
            </div>

            <!-- Dashboard Manager Module -->
            <div id="dashboardsModule" class="module-content" style="display: none;">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold" style="color: var(--sapphire);">Dashboard Manager</h2>
                    <p class="mt-2" style="color: var(--text-muted);">Manage dashboard ownership, sharing, and deletion at scale</p>
                </div>

                <!-- Controls -->
                <div class="mb-6 space-y-4">
                    <div class="flex flex-wrap gap-4">
                        <input type="text" id="searchDashboards" placeholder="Search dashboards..." class="flex-1 min-w-[200px] px-4 py-2 rounded border">
                        <input type="text" id="filterOwner" placeholder="Filter by owner..." class="flex-1 min-w-[200px] px-4 py-2 rounded border">
                        <button id="loadDashboardsBtn" class="btn-primary px-6 py-2 rounded font-semibold">
                            Load Dashboards
                        </button>
                    </div>

                    <!-- Bulk Actions -->
                    <div id="bulkActions" class="flex flex-wrap gap-3" style="display: none;">
                        <button id="bulkChangeOwnerBtn" class="btn-secondary px-4 py-2 rounded font-semibold">
                            Change Owner
                        </button>
                        <button id="bulkShareBtn" class="btn-secondary px-4 py-2 rounded font-semibold">
                            Modify Sharing
                        </button>
                        <button id="bulkDeleteBtn" class="btn-danger px-4 py-2 rounded font-semibold">
                            Delete Selected
                        </button>
                        <span id="selectedCount" class="px-4 py-2 font-semibold" style="color: var(--text-secondary);"></span>
                    </div>
                </div>

                <!-- Loading State -->
                <div id="dashboardsLoading" class="text-center py-20" style="display: none;">
                    <div class="spinner mx-auto mb-4"></div>
                    <p style="color: var(--text-muted);">Loading dashboards...</p>
                </div>

                <!-- Dashboard Table -->
                <div id="dashboardsTableContainer" class="table-container rounded-lg overflow-hidden" style="display: none;">
                    <table id="dashboardsTable">
                        <thead>
                            <tr>
                                <th width="40">
                                    <input type="checkbox" id="selectAll">
                                </th>
                                <th>Dashboard Name</th>
                                <th width="150">Owner</th>
                                <th width="200">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="dashboardsTableBody">
                            <!-- Populated dynamically -->
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                <div id="paginationContainer" class="mt-6 flex justify-between items-center" style="display: none;">
                    <div style="color: var(--text-secondary);">
                        <span id="paginationInfo"></span>
                    </div>
                    <div class="flex gap-2">
                        <button id="prevPageBtn" class="btn-secondary px-4 py-2 rounded">Previous</button>
                        <button id="nextPageBtn" class="btn-secondary px-4 py-2 rounded">Next</button>
                    </div>
                </div>
            </div>

            <!-- Records Report Module -->
            <div id="crs-usageModule" class="module-content" style="display: none;">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold" style="color: var(--sapphire);">Records Report</h2>
                    <p class="mt-2" style="color: var(--text-muted);">Analyze record storage capacity and compression ratios</p>
                </div>

                <!-- Configuration Section -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <!-- Time Period Selection -->
                    <div class="p-6 rounded-lg" style="background-color: var(--bg-card); border: 1px solid var(--border-color);">
                        <h3 class="text-lg font-semibold mb-4" style="color: var(--text-primary);">Time Period</h3>
                        <div class="space-y-3">
                            <button class="crs-period-btn w-full text-left px-4 py-3 rounded border active" data-period="yesterday">
                                <div class="font-semibold">Yesterday</div>
                                <div class="text-xs" style="color: var(--text-muted);">Previous day's data</div>
                            </button>
                            <button class="crs-period-btn w-full text-left px-4 py-3 rounded border" data-period="week">
                                <div class="font-semibold">Last 7 Days</div>
                                <div class="text-xs" style="color: var(--text-muted);">Weekly trend analysis</div>
                            </button>
                            <button class="crs-period-btn w-full text-left px-4 py-3 rounded border" data-period="month">
                                <div class="font-semibold">Last 30 Days</div>
                                <div class="text-xs" style="color: var(--text-muted);">Monthly overview</div>
                            </button>
                        </div>
                    </div>

                    <!-- Capacity Data Input -->
                    <div class="p-6 rounded-lg" style="background-color: var(--bg-card); border: 1px solid var(--border-color);">
                        <h3 class="text-lg font-semibold mb-4" style="color: var(--text-primary);">Capacity Data (Optional)</h3>
                        <p class="text-sm mb-4" style="color: var(--text-muted);">Provide capacity data to calculate compression ratios. Leave blank to view raw record bytes only.</p>
                        
                        <!-- Input Method Selection -->
                        <div id="capacityInputSection" class="mb-4">
                            <div class="flex gap-3 mb-4">
                                <button class="capacity-input-btn flex-1 px-4 py-2 rounded border active" data-input="manual">
                                    Manual Entry
                                </button>
                                <button class="capacity-input-btn flex-1 px-4 py-2 rounded border" data-input="csv">
                                    CSV Upload
                                </button>
                            </div>
                        </div>

                        <!-- Manual Input Fields -->
                        <div id="manualCapacityInput" class="space-y-3">
                            <div>
                                <label class="block text-sm font-medium mb-2" style="color: var(--text-secondary);">Reserved Capacity (GB)</label>
                                <input type="number" id="reservedCapacity" placeholder="e.g., 1500" class="w-full px-3 py-2 rounded border">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2" style="color: var(--text-secondary);">Utilized Capacity (GB)</label>
                                <input type="number" id="utilizedCapacity" placeholder="e.g., 817" class="w-full px-3 py-2 rounded border">
                                <p class="text-xs mt-1" style="color: var(--text-muted);">From your data lake (BigQuery/LogScale/Elastic)</p>
                                <p id="manualCapacityTip360" class="text-xs mt-1" style="color: var(--text-muted); display: none;">
                                    For RevealX 360, you can find reserved and utilized capacity on the Administration page of your RevealX 360 Cloud Console.
                                </p>
                            </div>
                        </div>

                        <!-- CSV Upload Fields -->
                        <div id="csvCapacityInput" class="space-y-3" style="display: none;">
                            <div>
                                <label class="block text-sm font-medium mb-2" style="color: var(--text-secondary);">Upload Usage CSV</label>
                                <input type="file" id="csvFileInput" accept=".csv" class="w-full px-3 py-2 rounded border">
                                <p class="text-xs mt-1" style="color: var(--text-muted);">CSV with "Summary Date UTC", "Utilized", and "Reserved" columns</p>
                                <p id="csvCapacityTip360" class="text-xs mt-1" style="color: var(--text-muted); display: none;">
                                    For RevealX 360, you can export this data as the "R(x) 360 Detailed Tenant CRS Usage" report from Salesforce. If you are not an ExtraHop employee, contact your ExtraHop CSM to obtain this CSV.
                                </p>
                            </div>
                            <div id="csvPreview" style="display: none;">
                                <p class="text-sm font-medium mb-2" style="color: var(--text-secondary);">Parsed Data:</p>
                                <div class="p-3 rounded text-xs" style="background-color: var(--bg-subtle);">
                                    <div id="csvSummary"></div>
                                </div>
                            </div>
                        </div>

                        <!-- CRS Trend Analysis Tool Link -->
                        <div class="mt-4 pt-4" style="border-top: 1px solid var(--border-color);">
                            <a href="https://thomaswde.github.io/crs-report/" target="_blank" rel="noopener noreferrer" class="btn-primary w-full px-4 py-2 rounded font-semibold flex items-center justify-center gap-2" style="display: flex;">
                                <span>Open CRS Trend Analysis Tool</span>
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                                </svg>
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Generate Report Button -->
                <div class="mb-6">
                    <button id="generateCrsReport" class="btn-primary px-8 py-3 rounded font-semibold text-lg">
                        Generate Report
                    </button>
                </div>

                <!-- Loading State -->
                <div id="crsLoading" class="text-center py-20" style="display: none;">
                    <div class="spinner mx-auto mb-4"></div>
                    <p style="color: var(--text-muted);">Fetching appliance data and calculating metrics...</p>
                </div>

                <!-- Results Section -->
                <div id="crsResults" style="display: none;">
                    <!-- KPI Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                        <div class="p-6 rounded-lg text-center" style="background-color: var(--bg-card); border: 2px solid var(--cyan);">
                            <div class="text-sm font-medium mb-2" style="color: var(--text-muted);">Compression Ratio</div>
                            <div id="compressionRatio" class="text-4xl font-bold" style="color: var(--cyan);">-</div>
                            <div id="compressionRatioSubtext" class="text-xs mt-2" style="color: var(--text-muted);">1 GB stored : X GB ingested</div>
                        </div>
                        <div class="p-6 rounded-lg text-center" style="background-color: var(--bg-card); border: 2px solid var(--magenta);">
                            <div class="text-sm font-medium mb-2" style="color: var(--text-muted);">Total Record Bytes</div>
                            <div id="totalRecordBytes" class="text-4xl font-bold" style="color: var(--magenta);">-</div>
                            <div class="text-xs mt-2" style="color: var(--text-muted);">From all EDA appliances</div>
                        </div>
                        <div class="p-6 rounded-lg text-center" style="background-color: var(--bg-card); border: 2px solid var(--tangerine);">
                            <div class="text-sm font-medium mb-2" style="color: var(--text-muted);">Capacity Utilization</div>
                            <div id="capacityUtilization" class="text-4xl font-bold" style="color: var(--tangerine);">-</div>
                            <div id="capacityUtilizationSubtext" class="text-xs mt-2" style="color: var(--text-muted);">Of reserved capacity</div>
                        </div>
                    </div>

                    <!-- Charts -->
                    <div class="space-y-6">
                        <!-- Stacked Bar Chart -->
                        <div class="p-6 rounded-lg" style="background-color: var(--bg-card); border: 1px solid var(--border-color);">
                            <h3 id="stackedChartTitle" class="text-lg font-semibold mb-4" style="color: var(--text-primary);">Capacity Consumption by Sensor</h3>
                            <div style="position: relative; height: 150px;">
                                <canvas id="stackedBarChart"></canvas>
                            </div>
                        </div>

                        <!-- Bar Chart -->
                        <div class="p-6 rounded-lg" style="background-color: var(--bg-card); border: 1px solid var(--border-color);">
                            <h3 id="barChartTitle" class="text-lg font-semibold mb-4" style="color: var(--text-primary);">Utilization by Sensor</h3>
                            <div style="position: relative; height: 400px;">
                                <canvas id="sensorBarChart"></canvas>
                            </div>
                        </div>

                        <!-- Data Table -->
                        <div class="p-6 rounded-lg" style="background-color: var(--bg-card); border: 1px solid var(--border-color);">
                            <h3 class="text-lg font-semibold mb-4" style="color: var(--text-primary);">Detailed Breakdown</h3>
                            <div class="table-container rounded-lg overflow-hidden">
                                <table id="crsDataTable">
                                    <thead>
                                        <tr>
                                            <th>Sensor Name</th>
                                            <th>Platform</th>
                                            <th>Record Bytes (GB)</th>
                                            <th>After Compression (GB)</th>
                                        </tr>
                                    </thead>
                                    <tbody id="crsDataTableBody">
                                        <!-- Populated dynamically -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Network Localities Module -->
            <div id="localitiesModule" class="module-content" style="display: none;">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold" style="color: var(--sapphire);">Network Localities Manager</h2>
                    <p class="mt-2" style="color: var(--text-muted);">Manage network locality entries to designate IP addresses and CIDR blocks as internal or external</p>
                </div>

                <!-- Action Buttons -->
                <div class="flex flex-wrap gap-3 mb-6">
                    <button id="loadLocalities" class="btn-primary px-6 py-2 rounded font-semibold">
                        Load Existing Localities
                    </button>
                    <button id="addLocalityRow" class="btn-secondary px-6 py-2 rounded font-semibold" style="display: none;">
                        + Add Row
                    </button>
                    <button id="saveLocalityChanges" class="btn-primary px-6 py-2 rounded font-semibold" style="display: none;">
                        Save Changes
                    </button>
                    <label class="btn-secondary px-6 py-2 rounded font-semibold cursor-pointer" style="display: none;" id="uploadCsvLabel">
                        Upload CSV
                        <input type="file" id="localityCsvInput" accept=".csv" class="hidden">
                    </label>
                </div>

                <!-- Status Messages -->
                <div id="localityStatus" class="mb-4" style="display: none;">
                    <div class="p-4 rounded" style="background-color: var(--bg-card); border: 1px solid var(--border-color);">
                        <p id="localityStatusText" class="text-sm"></p>
                    </div>
                </div>

                <!-- Loading Indicator -->
                <div id="localitiesLoading" class="text-center py-12" style="display: none;">
                    <div class="spinner mx-auto mb-4"></div>
                    <p style="color: var(--text-muted);">Loading network localities...</p>
                </div>

                <!-- Localities Table -->
                <div id="localitiesTable" class="table-container rounded-lg overflow-x-auto" style="display: none;">
                    <table id="localitiesDataTable" class="w-full">
                        <thead>
                            <tr>
                                <th style="width: 20%;">Network Locality Name</th>
                                <th style="width: 30%;">IP Addresses and CIDR Blocks</th>
                                <th style="width: 15%;">Network Locality Type</th>
                                <th style="width: 25%;">Description</th>
                                <th style="width: 10%;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="localitiesTableBody">
                            <!-- Populated dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Audit Logs Module -->
            <div id="audit-logsModule" class="module-content" style="display: none;">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold" style="color: var(--sapphire);">Audit Log Analysis</h2>
                    <p class="mt-2" style="color: var(--text-muted);">Analyze audit log entries, user activity, and operation trends</p>
                </div>

                <!-- Configuration Section -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <!-- Settings -->
                    <div class="p-6 rounded-lg" style="background-color: var(--bg-card); border: 1px solid var(--border-color);">
                        <h3 class="text-lg font-semibold mb-4" style="color: var(--text-primary);">Settings</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-semibold mb-2" style="color: var(--text-secondary);">Lookback Period (Days)</label>
                                <input type="number" id="auditLogLookback" value="30" min="1" max="90" 
                                    class="w-full px-3 py-2 border rounded" style="background-color: var(--bg-input); border-color: var(--border-color);">
                                <p class="text-xs mt-1" style="color: var(--text-muted);">Maximum 90 days (ExtraHop audit log retention)</p>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-2" style="color: var(--text-secondary);">Batch Size</label>
                                <input type="number" id="auditLogBatchSize" value="1000" min="10" max="1000" 
                                    class="w-full px-3 py-2 border rounded" style="background-color: var(--bg-input); border-color: var(--border-color);">
                                <p class="text-xs mt-1" style="color: var(--text-muted);">Number of entries to fetch per request</p>
                            </div>
                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="p-6 rounded-lg" style="background-color: var(--bg-card); border: 1px solid var(--border-color);">
                        <h3 class="text-lg font-semibold mb-4" style="color: var(--text-primary);">Actions</h3>
                        <div class="space-y-3">
                            <button id="loadAuditLog" class="btn-primary w-full px-4 py-3 rounded font-semibold">
                                Load Audit Log
                            </button>
                            <button id="stopAuditLogLoad" class="btn-danger w-full px-4 py-3 rounded font-semibold" style="display: none;">
                                Stop Loading
                            </button>
                            <div id="exportAuditLogSection" style="display: none;">
                                <label class="block text-sm font-semibold mb-2" style="color: var(--text-secondary);">Export Operation Type</label>
                                <select id="exportOperationType" class="w-full px-3 py-2 border rounded mb-2" style="background-color: var(--bg-input); border-color: var(--border-color);">
                                    <option value="all">All Operations</option>
                                </select>
                                <button id="exportAuditLogCsv" class="btn-secondary w-full px-4 py-3 rounded font-semibold">
                                    Export to CSV
                                </button>
                            </div>
                        </div>
                        <div id="auditLogLoadingStatus" class="mt-4 text-sm" style="color: var(--text-muted); display: none;">
                            <div class="flex items-center">
                                <div class="animate-spin mr-2" style="width: 16px; height: 16px; border: 2px solid var(--cyan); border-top-color: transparent; border-radius: 50%;"></div>
                                <span id="auditLogLoadingText">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Status Display -->
                <div id="auditLogStatus" style="display: none;" class="mb-6">
                    <div class="p-4 rounded-lg" style="background-color: var(--bg-card); border: 1px solid var(--border-color);">
                        <div class="text-sm font-semibold" style="color: var(--text-primary);" id="auditLogStatusText"></div>
                    </div>
                </div>

                <!-- Charts Container -->
                <div id="auditLogChartsContainer" style="display: none;">
                    
                    <!-- Chart 1: Logs per Event Type -->
                    <div class="mb-8 p-6 rounded-lg" style="background-color: var(--bg-card); border: 1px solid var(--border-color);">
                        <h3 class="text-xl font-semibold mb-4" style="color: var(--sapphire);">Logs per Event Type</h3>
                        <div style="position: relative; height: 500px;">
                            <canvas id="chartEventTypes"></canvas>
                        </div>
                    </div>

                    <!-- Chart 2: Login Events per Day -->
                    <div id="chartLoginPerDayContainer" class="mb-8 p-6 rounded-lg" style="background-color: var(--bg-card); border: 1px solid var(--border-color); display: none;">
                        <h3 class="text-xl font-semibold mb-4" style="color: var(--sapphire);">Login Events per Day (All Users)</h3>
                        <div style="position: relative; height: 400px;">
                            <canvas id="chartLoginPerDay"></canvas>
                        </div>
                    </div>

                    <!-- Chart 3: Total Login Events by Username -->
                    <div id="chartLoginByUserContainer" class="mb-8 p-6 rounded-lg" style="background-color: var(--bg-card); border: 1px solid var(--border-color); display: none;">
                        <h3 class="text-xl font-semibold mb-4" style="color: var(--sapphire);">Total Login Events by Username</h3>
                        <div style="position: relative; height: 500px;">
                            <canvas id="chartLoginByUser"></canvas>
                        </div>
                    </div>

                    <!-- Chart 4: All Activity per Day by User -->
                    <div id="chartActivityByUserContainer" class="mb-8 p-6 rounded-lg" style="background-color: var(--bg-card); border: 1px solid var(--border-color); display: none;">
                        <h3 class="text-xl font-semibold mb-4" style="color: var(--sapphire);">All Activity per Day Broken Down by User</h3>
                        <div style="position: relative; height: 500px;">
                            <canvas id="chartActivityByUser"></canvas>
                        </div>
                    </div>

                </div>
            </div>

            <!-- Nodemap Module -->
            <div id="nodemapModule" class="module-content" style="display: none;">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold" style="color: var(--sapphire);">Appliance Node Map</h2>
                    <p class="mt-2" style="color: var(--text-muted);">Visualize your ExtraHop appliance topology and relationships</p>
                </div>

                <!-- Graph Container -->
                <div id="graphContainer" class="w-full h-full relative" style="display: none;">
                    <!-- Main graph area that adjusts width when details panel is open -->
                    <div id="graphMainArea" class="transition-all duration-300" style="width: 100%;">
                        <svg id="nodeGraph" class="w-full h-full"></svg>
                    </div>
                    
                    <!-- Controls positioned absolutely over the graph -->
                    <div id="nodemapControls" class="absolute top-8 left-4 flex gap-3 z-10" style="display: none;">
                        <button id="showNodemapFilters" class="btn-secondary px-3 py-2 rounded text-sm flex items-center shadow-md">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path>
                            </svg>
                            Filters
                        </button>
                        <input type="text" id="nodemapSearch" placeholder="Search appliances..." class="px-3 py-2 rounded border text-sm shadow-md" style="width: 200px;">
                    </div>

                    <!-- Node Details Right Panel -->
                    <div id="nodeDetailsPanel" class="absolute top-0 right-0 h-full w-96 transform translate-x-full transition-transform duration-300 ease-in-out z-20" style="background-color: var(--bg-card); border-left: 1px solid var(--border-color); display: none;">
                        <div class="flex flex-col h-full">
                            <!-- Panel Header -->
                            <div class="flex items-center justify-between p-4 border-b" style="border-color: var(--border-color);">
                                <h3 class="text-lg font-semibold" style="color: var(--sapphire);">Appliance Details</h3>
                                <button id="closeNodeDetailsPanel" class="text-gray-400 hover:text-gray-600 transition-colors">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>
                            </div>
                            
                            <!-- Panel Content -->
                            <div id="nodeDetailsPanelContent" class="flex-1 overflow-y-auto p-4"></div>
                        </div>
                    </div>
                </div>

                <!-- Welcome Screen (shown when not connected/loaded) -->
                <div id="nodemapWelcome" class="flex items-center justify-center h-96">
                    <div class="text-center p-8">
                        <svg class="w-16 h-16 mx-auto mb-4" style="color: var(--tangerine);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                        </svg>
                        <h3 class="text-xl font-semibold mb-4" style="color: var(--text-primary);">Connect to View Node Map</h3>
                        <p class="text-sm" style="color: var(--text-muted);">Connect to your ExtraHop deployment to visualize the appliance topology.</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Error Modal -->
    <div id="errorModal" class="modal">
        <div class="modal-content">
            <h2 class="text-xl font-bold mb-4" style="color: var(--text-primary);">Connection Error</h2>
            <p id="errorMessage" class="mb-4" style="color: var(--text-secondary);"></p>
            
            <div class="mb-4">
                <button id="toggleErrorDetails" class="btn-secondary px-4 py-2 rounded text-sm">
                    Show Technical Details
                </button>
            </div>
            
            <div id="errorDetails" style="display: none;">
                <div class="bg-gray-50 p-3 rounded text-xs space-y-2">
                    <div><strong>URL:</strong> <code id="errorUrl"></code></div>
                    <div><strong>Headers:</strong> <pre id="errorHeaders" class="whitespace-pre-wrap"></pre></div>
                    <div><strong>Body:</strong> <pre id="errorBody" class="whitespace-pre-wrap"></pre></div>
                    <div><strong>Status:</strong> <code id="errorStatus"></code></div>
                    <div><strong>Response:</strong> <pre id="errorResponse" class="whitespace-pre-wrap"></pre></div>
                </div>
            </div>
            
            <div class="flex justify-end mt-6">
                <button id="closeErrorModal" class="btn-primary px-4 py-2 rounded">Close</button>
            </div>
        </div>
    </div>

    

    <!-- Change Owner Modal -->
    <div id="changeOwnerModal" class="modal">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-4" style="color: var(--sapphire);">Change Dashboard Owner</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2" style="color: var(--text-secondary);">New Owner</label>
                    <select id="newOwnerSelect" class="w-full px-3 py-2 rounded border">
                        <option value="">Select a user...</option>
                    </select>
                </div>
                <div class="flex items-center">
                    <input type="checkbox" id="grantEditAccess" class="mr-2">
                    <label for="grantEditAccess" class="text-sm" style="color: var(--text-secondary);">Grant previous owner edit access</label>
                </div>
                <div class="flex gap-3 mt-6">
                    <button id="confirmChangeOwner" class="btn-primary flex-1 px-4 py-2 rounded font-semibold">
                        Change Owner
                    </button>
                    <button id="cancelChangeOwner" class="btn-secondary flex-1 px-4 py-2 rounded font-semibold">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modify Sharing Modal -->
    <div id="modifySharingModal" class="modal">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-4" style="color: var(--sapphire);">Modify Dashboard Sharing</h3>
            <div class="space-y-4">
                <div class="flex items-center">
                    <input type="checkbox" id="shareWithAll" class="mr-2">
                    <label for="shareWithAll" class="text-sm" style="color: var(--text-secondary);">Share with all users (viewer access)</label>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2" style="color: var(--text-secondary);">Additional Editors</label>
                    <select id="additionalEditorsSelect" multiple class="w-full px-3 py-2 rounded border" size="6">
                    </select>
                    <p class="text-xs mt-1" style="color: var(--text-muted);">Hold Ctrl/Cmd to select multiple users</p>
                </div>
                <div class="flex gap-3 mt-6">
                    <button id="confirmModifySharing" class="btn-primary flex-1 px-4 py-2 rounded font-semibold">
                        Update Sharing
                    </button>
                    <button id="cancelModifySharing" class="btn-secondary flex-1 px-4 py-2 rounded font-semibold">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteConfirmModal" class="modal">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-4" style="color: #ef4444;">Confirm Deletion</h3>
            <p class="mb-6" style="color: var(--text-secondary);">
                Are you sure you want to delete <strong id="deleteCount"></strong>?
            </p>
            <p class="mb-6 text-sm" style="color: var(--text-muted);">
                This action cannot be undone.
            </p>
            <div class="flex gap-3">
                <button id="confirmDelete" class="btn-danger flex-1 px-4 py-2 rounded font-semibold">
                    Delete
                </button>
                <button id="cancelDelete" class="btn-secondary flex-1 px-4 py-2 rounded font-semibold">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Nodemap Filters Modal -->
    <div id="nodemapFiltersModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold" style="color: var(--sapphire);">Appliance Filters</h3>
                <button id="closeNodemapFilters" style="color: var(--text-muted);" class="hover:opacity-70">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <div class="space-y-6">
                <!-- Platform Types -->
                <div>
                    <h4 class="font-semibold mb-3" style="color: var(--text-primary);">Platform Types</h4>
                    <div class="space-y-2 text-sm">
                        <label class="flex items-center gap-2 cursor-pointer hover:opacity-80">
                            <input type="checkbox" id="filter-discover" checked class="w-4 h-4" style="accent-color: var(--lime);">
                            <span style="color: var(--lime);">â—</span>
                            <span>Packet Sensor</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer hover:opacity-80">
                            <input type="checkbox" id="filter-efc" checked class="w-4 h-4" style="accent-color: #a855f7;">
                            <span style="color: #a855f7;">â—</span>
                            <span>Flow Collector</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer hover:opacity-80">
                            <input type="checkbox" id="filter-trace" checked class="w-4 h-4" style="accent-color: var(--tangerine);">
                            <span style="color: var(--tangerine);">â—</span>
                            <span>Packetstore</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer hover:opacity-80">
                            <input type="checkbox" id="filter-other" checked class="w-4 h-4">
                            <span style="color: var(--text-secondary);">â—</span>
                            <span>Other</span>
                        </label>
                    </div>
                </div>

                <!-- Deployment Types -->
                <div>
                    <h4 class="font-semibold mb-3" style="color: var(--text-primary);">Deployment Types</h4>
                    <div class="space-y-2 text-sm">
                        <label class="flex items-center gap-2 cursor-pointer hover:opacity-80">
                            <input type="checkbox" id="filter-physical" checked class="w-4 h-4">
                            <span>Physical</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer hover:opacity-80">
                            <input type="checkbox" id="filter-virtual" checked class="w-4 h-4">
                            <span>Virtual/Cloud</span>
                        </label>
                    </div>
                </div>

                <!-- Connection Status -->
                <div>
                    <h4 class="font-semibold mb-3" style="color: var(--text-primary);">Connection Status</h4>
                    <div class="space-y-2 text-sm">
                        <label class="flex items-center gap-2 cursor-pointer hover:opacity-80">
                            <input type="checkbox" id="filter-online" checked class="w-4 h-4" style="accent-color: #10b981;">
                            <span style="color: #10b981;">â—</span>
                            <span>Online</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer hover:opacity-80">
                            <input type="checkbox" id="filter-offline" checked class="w-4 h-4" style="accent-color: #ef4444;">
                            <span style="color: #ef4444;">â—</span>
                            <span>Offline</span>
                        </label>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex gap-3 pt-4 border-t" style="border-color: var(--border-color);">
                    <button id="resetNodemapFilters" class="btn-secondary flex-1 px-4 py-2 rounded font-semibold">
                        Reset All
                    </button>
                    <button id="applyNodemapFilters" class="btn-primary flex-1 px-4 py-2 rounded font-semibold">
                        Apply Filters
                    </button>
                </div>
            </div>
        </div>
    </div>


    <!-- Load JavaScript Modules -->
    <script src="js/utils/app-state.js"></script>
    <script src="js/api-client/extrahop-api.js"></script>
    <script src="js/utils/common.js"></script>
    <script src="js/auth/auth-manager.js"></script>
    <script src="js/utils/module-loader.js"></script>
    <script src="js/app.js"></script>
</body>
</html>