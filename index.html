<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ExtraHop API Tools</title>
    <link rel="icon" href="favicon.png" type="image/png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Source+Sans+3:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f9fafb;
            --bg-card: #ffffff;
            --bg-input: #ffffff;
            --bg-hover: #f3f4f6;
            --bg-subtle: #f3f4f6;
            --text-primary: #261f63;
            --text-secondary: #4b5563;
            --text-muted: #6b7280;
            --border-color: #e5e7eb;
            --sapphire: #261f63;
            --plum: #7f2854;
            --magenta: #ec0089;
            --cyan: #00aaef;
            --tangerine: #f05918;
            --lime: #dae343;
            --ribbon-height: 60px;
        }

        .dark-theme {
            --bg-primary: #1f1f1f;
            --bg-secondary: #313131;
            --bg-card: #424242;
            --bg-input: #424242;
            --bg-hover: #535353;
            --bg-subtle: #424242;
            --text-primary: #f3f4f6;
            --text-secondary: #d1d5db;
            --text-muted: #9ca3af;
            --border-color: #4b5563;
        }

        body {
            font-family: 'Source Sans 3', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            padding-top: var(--ribbon-height);
        }

        /* Fixed Top Ribbon */
        .top-ribbon {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: var(--ribbon-height);
            background-color: var(--bg-card);
            border-bottom: 2px solid var(--border-color);
            display: flex;
            align-items: center;
            padding: 0 24px;
            z-index: 100;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .ribbon-logo {
            height: 40px;
            width: auto;
        }

        .ribbon-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
            margin-left: 16px;
        }

        .ribbon-module-title {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            font-size: 18px;
            font-weight: 600;
            color: var(--sapphire);
        }

        .content-wrapper {
            min-height: calc(100vh - var(--ribbon-height));
        }

        aside { 
            background-color: var(--bg-secondary); 
            border-color: var(--border-color); 
        }

        .module-btn {
            transition: all 0.2s;
            border-left: 3px solid transparent;
        }

        .module-btn:hover {
            background-color: var(--bg-hover);
            border-left-color: var(--cyan);
        }

        .module-btn.active {
            background-color: var(--bg-hover);
            border-left-color: var(--cyan);
            font-weight: 600;
        }

        .btn-primary {
            background-color: var(--cyan);
            color: white;
            transition: all 0.2s;
        }

        .btn-primary:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background-color: var(--bg-card);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            transition: all 0.2s;
        }

        .btn-secondary:hover {
            background-color: var(--bg-hover);
        }

        .btn-danger {
            background-color: #ef4444;
            color: white;
            transition: all 0.2s;
        }

        .btn-danger:hover {
            background-color: #dc2626;
        }

        input[type="text"], 
        input[type="password"],
        select {
            background-color: var(--bg-input);
            border-color: var(--border-color);
            color: var(--text-primary);
        }

        input[type="checkbox"] {
            accent-color: var(--cyan);
        }

        .table-container {
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
        }

        table {
            width: 100%;
        }

        th {
            background-color: var(--bg-subtle);
            color: var(--text-secondary);
            font-weight: 600;
            text-align: left;
            padding: 12px;
            border-bottom: 2px solid var(--border-color);
        }

        td {
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-primary);
        }

        tr:hover {
            background-color: var(--bg-hover);
        }

        .badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-success {
            background-color: #dcfce7;
            color: #166534;
        }

        .badge-warning {
            background-color: #fef3c7;
            color: #92400e;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background-color: var(--bg-card);
            border-radius: 8px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .spinner {
            border: 3px solid var(--bg-subtle);
            border-top: 3px solid var(--cyan);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-secondary); }
        ::-webkit-scrollbar-thumb { background: #9ca3af; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
    </style>
</head>
<body>
    <!-- Fixed Top Ribbon -->
    <div class="top-ribbon">
        <img src="eh_logo.png" alt="ExtraHop" class="ribbon-logo">
        <span class="ribbon-title">API Tools</span>
        <span id="ribbonModuleTitle" class="ribbon-module-title"></span>
    </div>

    <div class="content-wrapper flex flex-col lg:flex-row min-h-screen">
        <!-- Sidebar -->
        <aside class="w-full lg:w-80 border-r p-6 space-y-6 lg:fixed lg:h-full lg:overflow-y-auto">
            <!-- Header -->
            <div>
                <h1 class="text-2xl font-bold" style="color: var(--sapphire);">ExtraHop API Tools</h1>
                <p class="text-sm mt-1" style="color: var(--text-muted);">Admin utilities for RevealX</p>
            </div>

            <!-- API Configuration -->
            <div id="apiConfigSection" class="space-y-4">
                <!-- Collapsed Connected State -->
                <div id="connectedState" class="hidden">
                    <div class="flex items-center justify-between p-3 rounded cursor-pointer" style="background-color: var(--bg-subtle);" onclick="toggleApiConfig()">
                        <div class="flex items-center">
                            <svg class="w-5 h-5 mr-2" style="color: var(--cyan);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                            </svg>
                            <span class="font-semibold" style="color: var(--text-primary);">Connected</span>
                        </div>
                        <svg id="expandIcon" class="w-5 h-5 transition-transform" style="color: var(--text-secondary);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </div>
                    <p class="text-xs mt-2 text-center" style="color: var(--text-muted);" id="connectedInfo"></p>
                </div>

                <!-- Expanded Config Form -->
                <div id="configForm">
                    <h2 class="text-lg font-semibold" style="color: var(--text-primary);">API Configuration</h2>
                
                <!-- Deployment Type -->
                <div>
                    <label class="block text-sm font-medium mb-2" style="color: var(--text-secondary);">Deployment Type</label>
                    <select id="deploymentType" class="w-full px-3 py-2 rounded border">
                        <option value="360">RevealX 360 (Cloud)</option>
                        <option value="enterprise">RevealX Enterprise (Self-Hosted)</option>
                    </select>
                </div>

                <!-- 360 Config -->
                <div id="config360" class="space-y-3">
                    <div>
                        <label class="block text-sm font-medium mb-2" style="color: var(--text-secondary);">Tenant Name</label>
                        <input type="text" id="tenantName" placeholder="e.g., extrahop-se" class="w-full px-3 py-2 rounded border">
                        <p class="text-xs mt-1" style="color: var(--text-muted);">From: tenant.api.cloud.extrahop.com</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2" style="color: var(--text-secondary);">API ID</label>
                        <input type="text" id="apiId" class="w-full px-3 py-2 rounded border">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2" style="color: var(--text-secondary);">API Secret</label>
                        <input type="password" id="apiSecret" class="w-full px-3 py-2 rounded border">
                    </div>
                </div>

                <!-- Enterprise Config -->
                <div id="configEnterprise" class="space-y-3" style="display: none;">
                    <div>
                        <label class="block text-sm font-medium mb-2" style="color: var(--text-secondary);">Hostname or IP</label>
                        <input type="text" id="enterpriseHost" placeholder="e.g., extrahop.company.com" class="w-full px-3 py-2 rounded border">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2" style="color: var(--text-secondary);">API Key</label>
                        <input type="password" id="enterpriseApiKey" class="w-full px-3 py-2 rounded border">
                    </div>
                </div>

                <button id="connectBtn" class="btn-primary w-full px-4 py-2 rounded font-semibold">
                    Connect
                </button>

                <div id="connectionStatus" class="text-sm text-center" style="display: none;">
                    <span id="statusText"></span>
                </div>
                </div> <!-- End configForm -->
            </div> <!-- End apiConfigSection -->

            <!-- Module Selection -->
            <div class="space-y-2" id="moduleSelection" style="display: none;">
                <h2 class="text-lg font-semibold mb-3" style="color: var(--text-primary);">Tools</h2>
                
                <button class="module-btn active w-full text-left px-4 py-3 rounded" data-module="dashboards">
                    <div class="font-semibold">Dashboard Manager</div>
                    <div class="text-xs" style="color: var(--text-muted);">Manage ownership & sharing</div>
                </button>

                <button class="module-btn w-full text-left px-4 py-3 rounded" data-module="audit-logs">
                    <div class="font-semibold">Audit Logs</div>
                    <div class="text-xs" style="color: var(--text-muted);">Coming soon</div>
                </button>

                <button class="module-btn w-full text-left px-4 py-3 rounded" data-module="detections">
                    <div class="font-semibold">Detections</div>
                    <div class="text-xs" style="color: var(--text-muted);">Coming soon</div>
                </button>

                <button class="module-btn w-full text-left px-4 py-3 rounded" data-module="devices">
                    <div class="font-semibold">Device Manager</div>
                    <div class="text-xs" style="color: var(--text-muted);">Coming soon</div>
                </button>

                <button class="module-btn w-full text-left px-4 py-3 rounded" data-module="analysis-priorities">
                    <div class="font-semibold">Analysis Priorities</div>
                    <div class="text-xs" style="color: var(--text-muted);">Coming soon</div>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 lg:ml-80 p-6">
            <!-- Welcome Screen -->
            <div id="welcomeScreen">
                <div class="max-w-2xl mx-auto text-center py-20">
                    <h2 class="text-3xl font-bold mb-4" style="color: var(--sapphire);">Welcome to ExtraHop API Tools</h2>
                    <p class="text-lg mb-8" style="color: var(--text-secondary);">
                        Connect to your ExtraHop instance to get started with powerful API-driven admin utilities.
                    </p>
                    <div class="space-y-4 text-left" style="color: var(--text-muted);">
                        <div class="flex items-start">
                            <svg class="w-6 h-6 mr-3 flex-shrink-0" style="color: var(--cyan);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <div>
                                <strong>Bulk Dashboard Management</strong> - Change ownership, modify sharing, and delete dashboards at scale
                            </div>
                        </div>
                        <div class="flex items-start">
                            <svg class="w-6 h-6 mr-3 flex-shrink-0" style="color: var(--cyan);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <div>
                                <strong>Secure & Local</strong> - All credentials stored in session storage, cleared when you close the tab
                            </div>
                        </div>
                        <div class="flex items-start">
                            <svg class="w-6 h-6 mr-3 flex-shrink-0" style="color: var(--cyan);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <div>
                                <strong>More Coming Soon</strong> - Audit logs, detections, devices, and more utilities in development
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Dashboard Manager Module -->
            <div id="dashboardsModule" class="module-content" style="display: none;">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold" style="color: var(--sapphire);">Dashboard Manager</h2>
                    <p class="mt-2" style="color: var(--text-muted);">Manage dashboard ownership, sharing, and deletion at scale</p>
                </div>

                <!-- Controls -->
                <div class="mb-6 space-y-4">
                    <div class="flex flex-wrap gap-4">
                        <input type="text" id="searchDashboards" placeholder="Search dashboards..." class="flex-1 min-w-[200px] px-4 py-2 rounded border">
                        <input type="text" id="filterOwner" placeholder="Filter by owner..." class="flex-1 min-w-[200px] px-4 py-2 rounded border">
                        <button id="loadDashboardsBtn" class="btn-primary px-6 py-2 rounded font-semibold">
                            Load Dashboards
                        </button>
                    </div>

                    <!-- Bulk Actions -->
                    <div id="bulkActions" class="flex flex-wrap gap-3" style="display: none;">
                        <button id="bulkChangeOwnerBtn" class="btn-secondary px-4 py-2 rounded font-semibold">
                            Change Owner
                        </button>
                        <button id="bulkShareBtn" class="btn-secondary px-4 py-2 rounded font-semibold">
                            Modify Sharing
                        </button>
                        <button id="bulkDeleteBtn" class="btn-danger px-4 py-2 rounded font-semibold">
                            Delete Selected
                        </button>
                        <span id="selectedCount" class="px-4 py-2 font-semibold" style="color: var(--text-secondary);"></span>
                    </div>
                </div>

                <!-- Loading State -->
                <div id="dashboardsLoading" class="text-center py-20" style="display: none;">
                    <div class="spinner mx-auto mb-4"></div>
                    <p style="color: var(--text-muted);">Loading dashboards...</p>
                </div>

                <!-- Dashboard Table -->
                <div id="dashboardsTableContainer" class="table-container rounded-lg overflow-hidden" style="display: none;">
                    <table id="dashboardsTable">
                        <thead>
                            <tr>
                                <th width="40">
                                    <input type="checkbox" id="selectAll">
                                </th>
                                <th>Dashboard Name</th>
                                <th width="150">Owner</th>
                                <th width="100">Shared</th>
                                <th width="200">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="dashboardsTableBody">
                            <!-- Populated dynamically -->
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                <div id="paginationContainer" class="mt-6 flex justify-between items-center" style="display: none;">
                    <div style="color: var(--text-secondary);">
                        <span id="paginationInfo"></span>
                    </div>
                    <div class="flex gap-2">
                        <button id="prevPageBtn" class="btn-secondary px-4 py-2 rounded">Previous</button>
                        <button id="nextPageBtn" class="btn-secondary px-4 py-2 rounded">Next</button>
                    </div>
                </div>
            </div>

            <!-- Placeholder Modules -->
            <div id="audit-logsModule" class="module-content" style="display: none;">
                <div class="text-center py-20">
                    <h2 class="text-2xl font-bold mb-4" style="color: var(--sapphire);">Audit Logs</h2>
                    <p style="color: var(--text-muted);">This module is coming soon</p>
                </div>
            </div>

            <div id="detectionsModule" class="module-content" style="display: none;">
                <div class="text-center py-20">
                    <h2 class="text-2xl font-bold mb-4" style="color: var(--sapphire);">Detections</h2>
                    <p style="color: var(--text-muted);">This module is coming soon</p>
                </div>
            </div>

            <div id="devicesModule" class="module-content" style="display: none;">
                <div class="text-center py-20">
                    <h2 class="text-2xl font-bold mb-4" style="color: var(--sapphire);">Device Manager</h2>
                    <p style="color: var(--text-muted);">This module is coming soon</p>
                </div>
            </div>

            <div id="analysis-prioritiesModule" class="module-content" style="display: none;">
                <div class="text-center py-20">
                    <h2 class="text-2xl font-bold mb-4" style="color: var(--sapphire);">Analysis Priorities</h2>
                    <p style="color: var(--text-muted);">This module is coming soon</p>
                </div>
            </div>
        </main>
    </div>

    <!-- Change Owner Modal -->
    <div id="changeOwnerModal" class="modal">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-4" style="color: var(--sapphire);">Change Dashboard Owner</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2" style="color: var(--text-secondary);">New Owner</label>
                    <select id="newOwnerSelect" class="w-full px-3 py-2 rounded border">
                        <option value="">Select a user...</option>
                    </select>
                </div>
                <div class="flex items-center">
                    <input type="checkbox" id="grantEditAccess" class="mr-2">
                    <label for="grantEditAccess" class="text-sm" style="color: var(--text-secondary);">Grant previous owner edit access</label>
                </div>
                <div class="flex gap-3 mt-6">
                    <button id="confirmChangeOwner" class="btn-primary flex-1 px-4 py-2 rounded font-semibold">
                        Change Owner
                    </button>
                    <button id="cancelChangeOwner" class="btn-secondary flex-1 px-4 py-2 rounded font-semibold">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modify Sharing Modal -->
    <div id="modifySharingModal" class="modal">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-4" style="color: var(--sapphire);">Modify Dashboard Sharing</h3>
            <div class="space-y-4">
                <div class="flex items-center">
                    <input type="checkbox" id="shareWithAll" class="mr-2">
                    <label for="shareWithAll" class="text-sm" style="color: var(--text-secondary);">Share with all users (viewer access)</label>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2" style="color: var(--text-secondary);">Additional Editors</label>
                    <select id="additionalEditorsSelect" multiple class="w-full px-3 py-2 rounded border" size="6">
                    </select>
                    <p class="text-xs mt-1" style="color: var(--text-muted);">Hold Ctrl/Cmd to select multiple users</p>
                </div>
                <div class="flex gap-3 mt-6">
                    <button id="confirmModifySharing" class="btn-primary flex-1 px-4 py-2 rounded font-semibold">
                        Update Sharing
                    </button>
                    <button id="cancelModifySharing" class="btn-secondary flex-1 px-4 py-2 rounded font-semibold">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteConfirmModal" class="modal">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-4" style="color: #ef4444;">Confirm Deletion</h3>
            <p class="mb-6" style="color: var(--text-secondary);">
                Are you sure you want to delete <strong id="deleteCount"></strong>?
            </p>
            <p class="mb-6 text-sm" style="color: var(--text-muted);">
                This action cannot be undone.
            </p>
            <div class="flex gap-3">
                <button id="confirmDelete" class="btn-danger flex-1 px-4 py-2 rounded font-semibold">
                    Delete
                </button>
                <button id="cancelDelete" class="btn-secondary flex-1 px-4 py-2 rounded font-semibold">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Error Details Modal -->
    <div id="errorModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <h3 class="text-xl font-bold mb-4" style="color: #ef4444;">Connection Error</h3>
            <div class="mb-4">
                <p class="font-semibold mb-2" style="color: var(--text-primary);">Error Message:</p>
                <p id="errorMessage" class="mb-4 p-3 rounded" style="background-color: var(--bg-subtle); color: var(--text-secondary);"></p>
            </div>
            <div class="mb-4">
                <button id="toggleErrorDetails" class="btn-secondary px-4 py-2 rounded font-semibold mb-3">
                    Show Technical Details
                </button>
                <div id="errorDetails" style="display: none;">
                    <div class="mb-3">
                        <p class="font-semibold mb-1 text-sm" style="color: var(--text-secondary);">Request URL:</p>
                        <pre id="errorUrl" class="p-3 rounded text-xs overflow-x-auto" style="background-color: var(--bg-subtle); color: var(--text-muted);"></pre>
                    </div>
                    <div class="mb-3">
                        <p class="font-semibold mb-1 text-sm" style="color: var(--text-secondary);">Request Headers:</p>
                        <pre id="errorHeaders" class="p-3 rounded text-xs overflow-x-auto" style="background-color: var(--bg-subtle); color: var(--text-muted);"></pre>
                    </div>
                    <div class="mb-3">
                        <p class="font-semibold mb-1 text-sm" style="color: var(--text-secondary);">Request Body:</p>
                        <pre id="errorBody" class="p-3 rounded text-xs overflow-x-auto" style="background-color: var(--bg-subtle); color: var(--text-muted);"></pre>
                    </div>
                    <div class="mb-3">
                        <p class="font-semibold mb-1 text-sm" style="color: var(--text-secondary);">Response Status:</p>
                        <pre id="errorStatus" class="p-3 rounded text-xs" style="background-color: var(--bg-subtle); color: var(--text-muted);"></pre>
                    </div>
                    <div>
                        <p class="font-semibold mb-1 text-sm" style="color: var(--text-secondary);">Response Body:</p>
                        <pre id="errorResponse" class="p-3 rounded text-xs overflow-x-auto" style="background-color: var(--bg-subtle); color: var(--text-muted);"></pre>
                    </div>
                </div>
            </div>
            <button id="closeErrorModal" class="btn-primary w-full px-4 py-2 rounded font-semibold">
                Close
            </button>
        </div>
    </div>

    <script>
        // Global State
        const state = {
            apiConfig: null,
            connected: false,
            currentModule: 'dashboards',
            dashboards: [],
            allUsers: [],
            filteredDashboards: [],
            selectedDashboards: new Set(),
            currentPage: 1,
            itemsPerPage: 50
        };

        // Configuration - Lambda proxy URL (360 only)
        const LAMBDA_PROXY_URL = 'https://mdpg23urni.execute-api.us-east-2.amazonaws.com/default/extrahop-api-wrapper-proxy';

        // API Client (hybrid: Lambda for 360, direct for Enterprise)
        class ExtraHopAPI {
            constructor(config) {
                this.config = config;
                this.proxyUrl = LAMBDA_PROXY_URL;
                
                // For Enterprise, set up direct API URL
                if (config.type === 'enterprise') {
                    this.baseUrl = `https://${config.host}/api/v1`;
                }
            }

            async authenticate() {
                if (this.config.type === '360') {
                    // 360: Use Lambda proxy for OAuth
                    const proxyRequest = {
                        deploymentType: '360',
                        tenant: this.config.tenant,
                        apiId: this.config.apiId,
                        apiSecret: this.config.apiSecret,
                        method: 'POST',
                        endpoint: '/oauth2/token'
                    };

                    try {
                        const response = await fetch(this.proxyUrl, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(proxyRequest)
                        });

                        const responseText = await response.text();
                        let responseData;
                        try {
                            responseData = JSON.parse(responseText);
                        } catch (e) {
                            responseData = responseText;
                        }

                        if (!response.ok) {
                            const errorDetails = {
                                url: this.proxyUrl,
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(proxyRequest, null, 2),
                                status: `${response.status} ${response.statusText}`,
                                response: responseData
                            };
                            
                            let errorMessage = 'Authentication failed. ';
                            if (response.status === 401) {
                                errorMessage += 'Invalid API ID or Secret (401 Unauthorized).';
                            } else if (response.status === 403) {
                                errorMessage += 'Access forbidden (403 Forbidden). Check API permissions.';
                            } else if (response.status === 404) {
                                errorMessage += 'Endpoint not found (404). Check tenant name.';
                            } else if (response.status === 400) {
                                errorMessage += `Bad request: ${responseData.error || 'Check configuration'}`;
                            } else {
                                errorMessage += `Server returned ${response.status} ${response.statusText}.`;
                            }

                            showErrorModal(errorMessage, errorDetails);
                            throw new Error(errorMessage);
                        }

                        this.accessToken = responseData.access_token;
                        sessionStorage.setItem('eh_access_token', responseData.access_token);
                        return true;
                    } catch (error) {
                        if (error.message.includes('Authentication failed')) {
                            throw error;
                        }
                        const errorDetails = {
                            url: this.proxyUrl,
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(proxyRequest, null, 2),
                            status: 'Network Error',
                            response: error.message
                        };
                        const errorMessage = `Network error: ${error.message}. Check Lambda proxy URL: ${this.proxyUrl}`;
                        showErrorModal(errorMessage, errorDetails);
                        throw new Error(errorMessage);
                    }
                } else {
                    // Enterprise: Direct API call to test connection
                    const requestUrl = `${this.baseUrl}/extrahop`;
                    const requestHeaders = {
                        'Authorization': `ExtraHop apikey=${this.config.apiKey}`,
                        'Accept': 'application/json'
                    };

                    try {
                        const response = await fetch(requestUrl, {
                            headers: requestHeaders
                        });

                        const responseText = await response.text();
                        let responseData;
                        try {
                            responseData = JSON.parse(responseText);
                        } catch (e) {
                            responseData = responseText;
                        }

                        if (!response.ok) {
                            const errorDetails = {
                                url: requestUrl,
                                headers: requestHeaders,
                                body: 'N/A',
                                status: `${response.status} ${response.statusText}`,
                                response: responseData
                            };
                            
                            let errorMessage = 'Authentication failed. ';
                            if (response.status === 401) {
                                errorMessage += 'Invalid API key (401 Unauthorized).';
                            } else if (response.status === 403) {
                                errorMessage += 'Access forbidden (403 Forbidden). Check API key permissions.';
                            } else if (response.status === 404) {
                                errorMessage += 'Endpoint not found (404). Check hostname.';
                            } else if (response.status === 400) {
                                errorMessage += `Bad request: ${responseData.error_message || 'Check configuration'}`;
                            } else {
                                errorMessage += `Server returned ${response.status} ${response.statusText}.`;
                            }

                            showErrorModal(errorMessage, errorDetails);
                            throw new Error(errorMessage);
                        }

                        return true;
                    } catch (error) {
                        if (error.message.includes('Authentication failed')) {
                            throw error;
                        }
                        const errorDetails = {
                            url: requestUrl,
                            headers: requestHeaders,
                            body: 'N/A',
                            status: 'Network Error',
                            response: error.message
                        };
                        
                        let errorMessage = `Network error: ${error.message}. `;
                        if (error.message.includes('Failed to fetch')) {
                            errorMessage += 'This is likely a CORS issue. For Enterprise instances, you need to either:\n' +
                                '1. Enable CORS on your ExtraHop appliance for this domain\n' +
                                '2. Use a browser extension version of this tool\n' +
                                '3. Run locally with CORS disabled for testing';
                        }
                        
                        showErrorModal(errorMessage, errorDetails);
                        throw new Error(errorMessage);
                    }
                }
            }

            async request(endpoint, options = {}) {
                // Ensure endpoint starts with /api/v1 unless it's the OAuth token endpoint
                if (!endpoint.startsWith('/api/v1') && !endpoint.startsWith('/oauth2')) {
                    endpoint = '/api/v1' + endpoint;
                }

                const makeRequest = async () => {
                    if (this.config.type === '360') {
                        // 360: Use Lambda proxy
                        const proxyRequest = {
                            deploymentType: '360',
                            tenant: this.config.tenant,
                            accessToken: this.accessToken,
                            method: options.method || 'GET',
                            endpoint: endpoint
                        };

                        if (options.body) {
                            proxyRequest.requestBody = JSON.parse(options.body);
                        }

                        const response = await fetch(this.proxyUrl, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(proxyRequest)
                        });

                        // Check for success status codes (2xx)
                        if (response.status < 200 || response.status >= 300) {
                            const error = await response.text();
                            let errorMessage;
                            try {
                                const errorJson = JSON.parse(error);
                                errorMessage = errorJson.error_message || error;
                            } catch (e) {
                                errorMessage = error;
                            }
                            throw new Error(`API Error: ${response.status} - ${errorMessage}`);
                        }

                        // Handle different success responses
                        if (response.status === 204) {
                            return {};
                        }

                        const text = await response.text();
                        return text ? JSON.parse(text) : {};
                    } else {
                        // Enterprise: Direct API call
                        const url = `${this.baseUrl}${endpoint.startsWith('/api/v1') ? endpoint.substring(7) : endpoint}`;
                        
                        const response = await fetch(url, {
                            method: options.method || 'GET',
                            headers: {
                                'Authorization': `ExtraHop apikey=${this.config.apiKey}`,
                                'Content-Type': 'application/json',
                                'Accept': 'application/json'
                            },
                            body: options.body
                        });

                        // Check for success status codes (2xx)
                        if (response.status < 200 || response.status >= 300) {
                            const error = await response.text();
                            let errorMessage;
                            try {
                                const errorJson = JSON.parse(error);
                                errorMessage = errorJson.error_message || error;
                            } catch (e) {
                                errorMessage = error;
                            }
                            throw new Error(`API Error: ${response.status} - ${errorMessage}`);
                        }

                        // Handle different success responses
                        if (response.status === 204) {
                            return {};
                        }

                        const text = await response.text();
                        return text ? JSON.parse(text) : {};
                    }
                };

                // Try the request, if 401 and 360, refresh token and retry once
                try {
                    return await makeRequest();
                } catch (error) {
                    if (error.message.includes('401') && this.config.type === '360') {
                        console.log('Token expired, attempting refresh...');
                        
                        // Refresh the token
                        const tempApi = new ExtraHopAPI(this.config);
                        await tempApi.authenticate();
                        this.accessToken = tempApi.accessToken;
                        
                        console.log('Token refreshed, retrying request...');
                        
                        // Retry once with new token
                        return await makeRequest();
                    }
                    throw error;
                }
            }

            async getDashboards() {
                return this.request('/dashboards');
            }

            async getDashboardSharing(dashboardId) {
                return this.request(`/dashboards/${dashboardId}/sharing`);
            }

            async updateDashboard(dashboardId, body) {
                return this.request(`/dashboards/${dashboardId}`, {
                    method: 'PATCH',
                    body: JSON.stringify(body)
                });
            }

            async updateDashboardSharing(dashboardId, body) {
                return this.request(`/dashboards/${dashboardId}/sharing`, {
                    method: 'PATCH',
                    body: JSON.stringify(body)
                });
            }

            async deleteDashboard(dashboardId) {
                const proxyRequest = {
                    deploymentType: this.config.type,
                    method: 'DELETE',
                    endpoint: `/dashboards/${dashboardId}`
                };

                if (this.config.type === '360') {
                    proxyRequest.tenant = this.config.tenant;
                    proxyRequest.accessToken = this.accessToken;
                } else {
                    proxyRequest.host = this.config.host;
                    proxyRequest.apiKey = this.config.apiKey;
                }

                // Need to prepend /api/v1 manually here since deleteDashboard bypasses request()
                proxyRequest.endpoint = '/api/v1' + proxyRequest.endpoint;

                const response = await fetch(this.proxyUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(proxyRequest)
                });
                
                return response.ok;
            }

            async getUsers() {
                // For Enterprise, this endpoint may not be available
                // For 360, users endpoint should work
                try {
                    return await this.request('/users');
                } catch (e) {
                    console.warn('Could not fetch users:', e);
                    return [];
                }
            }
        }

        // UI Functions
        function showStatus(message, isError = false) {
            const statusDiv = document.getElementById('connectionStatus');
            const statusText = document.getElementById('statusText');
            statusDiv.style.display = 'block';
            statusText.textContent = message;
            statusText.style.color = isError ? '#ef4444' : 'var(--cyan)';
        }

        function toggleApiConfig() {
            const configForm = document.getElementById('configForm');
            const expandIcon = document.getElementById('expandIcon');
            
            if (configForm.style.display === 'none') {
                configForm.style.display = 'block';
                expandIcon.style.transform = 'rotate(0deg)';
            } else {
                configForm.style.display = 'none';
                expandIcon.style.transform = 'rotate(-90deg)';
            }
        }

        function showConnectedState() {
            const connectedState = document.getElementById('connectedState');
            const configForm = document.getElementById('configForm');
            const connectedInfo = document.getElementById('connectedInfo');
            
            connectedState.classList.remove('hidden');
            configForm.style.display = 'none';
            
            if (state.apiConfig.type === '360') {
                connectedInfo.textContent = `RevealX 360: ${state.apiConfig.tenant}`;
            } else {
                connectedInfo.textContent = `RevealX Enterprise: ${state.apiConfig.host}`;
            }
            
            document.getElementById('expandIcon').style.transform = 'rotate(-90deg)';
        }

        function hideConnectedState() {
            const connectedState = document.getElementById('connectedState');
            const configForm = document.getElementById('configForm');
            
            connectedState.classList.add('hidden');
            configForm.style.display = 'block';
        }

        async function refreshAccessToken() {
            if (!state.apiConfig || state.apiConfig.type !== '360') {
                return false;
            }

            console.log('Access token expired, refreshing...');
            
            try {
                const api = new ExtraHopAPI(state.apiConfig);
                await api.authenticate();
                
                // Update the global API client with new token
                window.apiClient.accessToken = api.accessToken;
                
                console.log('Access token refreshed successfully');
                return true;
            } catch (error) {
                console.error('Failed to refresh access token:', error);
                // Show error and ask user to reconnect
                alert('Your session has expired. Please reconnect.');
                hideConnectedState();
                state.connected = false;
                return false;
            }
        }

        // Wrapper for API requests that handles token refresh
        async function apiRequestWithRetry(apiMethod, ...args) {
            try {
                return await apiMethod(...args);
            } catch (error) {
                // Check if it's a 401 error (expired token)
                if (error.message.includes('401') && state.apiConfig?.type === '360') {
                    console.log('Detected 401, attempting token refresh...');
                    const refreshed = await refreshAccessToken();
                    
                    if (refreshed) {
                        // Retry the original request
                        return await apiMethod(...args);
                    }
                }
                // Re-throw if not a token issue or refresh failed
                throw error;
            }
        }

        function showErrorModal(message, details) {
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorUrl').textContent = details.url || 'N/A';
            document.getElementById('errorHeaders').textContent = JSON.stringify(details.headers || {}, null, 2);
            document.getElementById('errorBody').textContent = details.body || 'N/A';
            document.getElementById('errorStatus').textContent = details.status || 'N/A';
            document.getElementById('errorResponse').textContent = typeof details.response === 'object' 
                ? JSON.stringify(details.response, null, 2) 
                : details.response || 'N/A';
            
            document.getElementById('errorDetails').style.display = 'none';
            document.getElementById('toggleErrorDetails').textContent = 'Show Technical Details';
            showModal('errorModal');
        }

        function switchModule(moduleName) {
            // Update sidebar
            document.querySelectorAll('.module-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-module="${moduleName}"]`)?.classList.add('active');

            // Update content
            document.querySelectorAll('.module-content').forEach(module => {
                module.style.display = 'none';
            });
            document.getElementById('welcomeScreen').style.display = 'none';
            document.getElementById(`${moduleName}Module`).style.display = 'block';

            // Update ribbon module title
            const moduleTitles = {
                'dashboards': 'Dashboard Manager',
                'audit-logs': 'Audit Logs',
                'detections': 'Detections',
                'devices': 'Device Manager',
                'analysis-priorities': 'Analysis Priorities'
            };
            document.getElementById('ribbonModuleTitle').textContent = moduleTitles[moduleName] || '';

            state.currentModule = moduleName;
        }

        async function handleConnect() {
            const connectBtn = document.getElementById('connectBtn');
            const deploymentType = document.getElementById('deploymentType').value;

            try {
                connectBtn.disabled = true;
                connectBtn.textContent = 'Connecting...';

                let config;
                if (deploymentType === '360') {
                    config = {
                        type: '360',
                        tenant: document.getElementById('tenantName').value.trim(),
                        apiId: document.getElementById('apiId').value.trim(),
                        apiSecret: document.getElementById('apiSecret').value.trim()
                    };

                    if (!config.tenant || !config.apiId || !config.apiSecret) {
                        throw new Error('Please fill in all fields');
                    }
                } else {
                    config = {
                        type: 'enterprise',
                        host: document.getElementById('enterpriseHost').value.trim(),
                        apiKey: document.getElementById('enterpriseApiKey').value.trim()
                    };

                    if (!config.host || !config.apiKey) {
                        throw new Error('Please fill in all fields');
                    }
                }

                const api = new ExtraHopAPI(config);
                await api.authenticate();

                state.apiConfig = config;
                state.connected = true;
                sessionStorage.setItem('eh_config', JSON.stringify(config));
                window.apiClient = api;

                showStatus(' Connected successfully', false);
                document.getElementById('moduleSelection').style.display = 'block';
                showConnectedState();
                
                connectBtn.textContent = 'Connected';
                setTimeout(() => {
                    connectBtn.textContent = 'Reconnect';
                    connectBtn.disabled = false;
                }, 2000);

            } catch (error) {
                showStatus(' ' + error.message, true);
                connectBtn.textContent = 'Connect';
                connectBtn.disabled = false;
            }
        }

        async function loadDashboards() {
            if (!state.connected) {
                alert('Please connect to your ExtraHop instance first');
                return;
            }

            const loadBtn = document.getElementById('loadDashboardsBtn');
            const loadingDiv = document.getElementById('dashboardsLoading');
            const tableContainer = document.getElementById('dashboardsTableContainer');

            try {
                loadBtn.disabled = true;
                loadBtn.textContent = 'Loading...';
                loadingDiv.style.display = 'block';
                tableContainer.style.display = 'none';

                // Load dashboards
                state.dashboards = await window.apiClient.getDashboards();
                
                // Load users for owner dropdown
                state.allUsers = await window.apiClient.getUsers();

                // Get unique owners from dashboards
                const ownerSet = new Set();
                state.dashboards.forEach(d => {
                    if (d.owner) ownerSet.add(d.owner);
                });

                // Combine API users with owners found in dashboards
                const userSet = new Set([...state.allUsers.map(u => u.username), ...ownerSet]);
                state.allUsers = Array.from(userSet).sort().map(u => ({ username: u }));

                // Populate user dropdowns
                populateUserDropdowns();

                // Load sharing info for each dashboard (in background)
                loadDashboardSharing();

                // Initial render
                applyFilters();
                renderDashboards();

                loadingDiv.style.display = 'none';
                tableContainer.style.display = 'block';
                document.getElementById('paginationContainer').style.display = 'flex';

            } catch (error) {
                alert('Error loading dashboards: ' + error.message);
                loadingDiv.style.display = 'none';
            } finally {
                loadBtn.textContent = 'Refresh';
                loadBtn.disabled = false;
            }
        }

        async function loadDashboardSharing() {
            // Load sharing info for visible dashboards
            const promises = state.dashboards.map(async (dashboard) => {
                try {
                    const sharing = await window.apiClient.getDashboardSharing(dashboard.id);
                    dashboard.sharing = sharing;
                } catch (e) {
                    dashboard.sharing = { anyone: false, users: {}, groups: {} };
                }
            });

            await Promise.all(promises);
            renderDashboards(); // Re-render with sharing info
        }

        function populateUserDropdowns() {
            const newOwnerSelect = document.getElementById('newOwnerSelect');
            const additionalEditorsSelect = document.getElementById('additionalEditorsSelect');

            // Clear existing options
            newOwnerSelect.innerHTML = '<option value="">Select a user...</option>';
            additionalEditorsSelect.innerHTML = '';

            // Populate with users
            state.allUsers.forEach(user => {
                const option1 = document.createElement('option');
                option1.value = user.username;
                option1.textContent = user.username;
                newOwnerSelect.appendChild(option1);

                const option2 = document.createElement('option');
                option2.value = user.username;
                option2.textContent = user.username;
                additionalEditorsSelect.appendChild(option2);
            });
        }

        function applyFilters() {
            const searchTerm = document.getElementById('searchDashboards').value.toLowerCase();
            const ownerFilter = document.getElementById('filterOwner').value.toLowerCase();

            state.filteredDashboards = state.dashboards.filter(dashboard => {
                const nameMatch = !searchTerm || dashboard.name.toLowerCase().includes(searchTerm);
                const ownerMatch = !ownerFilter || (dashboard.owner && dashboard.owner.toLowerCase().includes(ownerFilter));
                return nameMatch && ownerMatch;
            });

            state.currentPage = 1;
        }

        function renderDashboards() {
            const tbody = document.getElementById('dashboardsTableBody');
            const start = (state.currentPage - 1) * state.itemsPerPage;
            const end = start + state.itemsPerPage;
            const pageData = state.filteredDashboards.slice(start, end);

            tbody.innerHTML = '';

            if (pageData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center py-8" style="color: var(--text-muted);">No dashboards found</td></tr>';
                return;
            }

            pageData.forEach(dashboard => {
                const row = document.createElement('tr');
                const isShared = dashboard.sharing?.anyone || 
                                Object.keys(dashboard.sharing?.users || {}).length > 0 || 
                                Object.keys(dashboard.sharing?.groups || {}).length > 0;

                row.innerHTML = `
                    <td>
                        <input type="checkbox" class="dashboard-checkbox" data-id="${dashboard.id}" ${state.selectedDashboards.has(dashboard.id) ? 'checked' : ''}>
                    </td>
                    <td>
                        <div class="font-semibold">${escapeHtml(dashboard.name)}</div>
                    </td>
                    <td>${escapeHtml(dashboard.owner || 'System')}</td>
                    <td>
                        ${isShared ? '<span class="badge badge-success">Yes</span>' : '<span class="badge badge-warning">Private</span>'}
                    </td>
                    <td>
                        <div class="flex gap-2">
                            <button class="btn-secondary px-3 py-1 rounded text-sm change-owner-btn" data-id="${dashboard.id}">
                                Change Owner
                            </button>
                            <button class="btn-danger px-3 py-1 rounded text-sm delete-btn" data-id="${dashboard.id}">
                                Delete
                            </button>
                        </div>
                    </td>
                `;

                tbody.appendChild(row);
            });

            updatePagination();
            updateBulkActions();
        }

        function updatePagination() {
            const totalPages = Math.ceil(state.filteredDashboards.length / state.itemsPerPage);
            const paginationInfo = document.getElementById('paginationInfo');
            const prevBtn = document.getElementById('prevPageBtn');
            const nextBtn = document.getElementById('nextPageBtn');

            const start = (state.currentPage - 1) * state.itemsPerPage + 1;
            const end = Math.min(start + state.itemsPerPage - 1, state.filteredDashboards.length);

            paginationInfo.textContent = `Showing ${start}-${end} of ${state.filteredDashboards.length}`;

            prevBtn.disabled = state.currentPage === 1;
            nextBtn.disabled = state.currentPage >= totalPages;
        }

        function updateBulkActions() {
            const bulkActions = document.getElementById('bulkActions');
            const selectedCount = document.getElementById('selectedCount');

            if (state.selectedDashboards.size > 0) {
                bulkActions.style.display = 'flex';
                selectedCount.textContent = `${state.selectedDashboards.size} selected`;
            } else {
                bulkActions.style.display = 'none';
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Modal Functions
        function showModal(modalId) {
            document.getElementById(modalId).classList.add('show');
        }

        function hideModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        async function handleBulkChangeOwner() {
            showModal('changeOwnerModal');
        }

        async function confirmChangeOwner() {
            const newOwner = document.getElementById('newOwnerSelect').value;
            const grantAccess = document.getElementById('grantEditAccess').checked;

            if (!newOwner) {
                alert('Please select a new owner');
                return;
            }

            const dashboardIds = Array.from(state.selectedDashboards);
            let successCount = 0;

            try {
                for (const id of dashboardIds) {
                    const dashboard = state.dashboards.find(d => d.id === id);
                    const oldOwner = dashboard.owner;

                    await window.apiClient.updateDashboard(id, { owner: newOwner });

                    if (grantAccess && oldOwner) {
                        await window.apiClient.updateDashboardSharing(id, {
                            users: { [oldOwner]: 'editor' }
                        });
                    }

                    successCount++;
                }

                alert(`Successfully changed owner for ${successCount} dashboard(s)`);
                hideModal('changeOwnerModal');
                loadDashboards();
            } catch (error) {
                alert(`Error: ${error.message}. Changed ${successCount} of ${dashboardIds.length} dashboards.`);
            }
        }

        async function handleBulkShare() {
            showModal('modifySharingModal');
        }

        async function confirmModifySharing() {
            const shareWithAll = document.getElementById('shareWithAll').checked;
            const editorsSelect = document.getElementById('additionalEditorsSelect');
            const selectedEditors = Array.from(editorsSelect.selectedOptions).map(opt => opt.value);

            const dashboardIds = Array.from(state.selectedDashboards);
            let successCount = 0;

            try {
                for (const id of dashboardIds) {
                    const sharingPayload = {};

                    if (shareWithAll) {
                        sharingPayload.anyone = 'viewer';
                    }

                    if (selectedEditors.length > 0) {
                        sharingPayload.users = {};
                        selectedEditors.forEach(username => {
                            sharingPayload.users[username] = 'editor';
                        });
                    }

                    await window.apiClient.updateDashboardSharing(id, sharingPayload);
                    successCount++;
                }

                alert(`Successfully updated sharing for ${successCount} dashboard(s)`);
                hideModal('modifySharingModal');
                loadDashboards();
            } catch (error) {
                alert(`Error: ${error.message}. Updated ${successCount} of ${dashboardIds.length} dashboards.`);
            }
        }

        async function handleBulkDelete() {
            const count = state.selectedDashboards.size;
            document.getElementById('deleteCount').textContent = `${count} dashboard${count > 1 ? 's' : ''}`;
            showModal('deleteConfirmModal');
        }

        async function confirmDelete() {
            const dashboardIds = Array.from(state.selectedDashboards);
            let successCount = 0;

            try {
                for (const id of dashboardIds) {
                    const success = await window.apiClient.deleteDashboard(id);
                    if (success) successCount++;
                }

                alert(`Successfully deleted ${successCount} dashboard(s)`);
                hideModal('deleteConfirmModal');
                state.selectedDashboards.clear();
                loadDashboards();
            } catch (error) {
                alert(`Error: ${error.message}. Deleted ${successCount} of ${dashboardIds.length} dashboards.`);
            }
        }

        // Event Listeners
        document.getElementById('deploymentType').addEventListener('change', (e) => {
            const is360 = e.target.value === '360';
            document.getElementById('config360').style.display = is360 ? 'block' : 'none';
            document.getElementById('configEnterprise').style.display = is360 ? 'none' : 'block';
        });

        document.getElementById('connectBtn').addEventListener('click', handleConnect);

        document.querySelectorAll('.module-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const module = e.currentTarget.dataset.module;
                if (state.connected) {
                    switchModule(module);
                }
            });
        });

        document.getElementById('loadDashboardsBtn').addEventListener('click', loadDashboards);
        document.getElementById('searchDashboards').addEventListener('input', () => {
            applyFilters();
            renderDashboards();
        });
        document.getElementById('filterOwner').addEventListener('input', () => {
            applyFilters();
            renderDashboards();
        });

        document.getElementById('selectAll').addEventListener('change', (e) => {
            const checkboxes = document.querySelectorAll('.dashboard-checkbox');
            checkboxes.forEach(cb => {
                cb.checked = e.target.checked;
                const id = parseInt(cb.dataset.id);
                if (e.target.checked) {
                    state.selectedDashboards.add(id);
                } else {
                    state.selectedDashboards.delete(id);
                }
            });
            updateBulkActions();
        });

        document.getElementById('dashboardsTableBody').addEventListener('change', (e) => {
            if (e.target.classList.contains('dashboard-checkbox')) {
                const id = parseInt(e.target.dataset.id);
                if (e.target.checked) {
                    state.selectedDashboards.add(id);
                } else {
                    state.selectedDashboards.delete(id);
                }
                updateBulkActions();
            }
        });

        document.getElementById('dashboardsTableBody').addEventListener('click', (e) => {
            if (e.target.classList.contains('change-owner-btn')) {
                const id = parseInt(e.target.dataset.id);
                state.selectedDashboards.clear();
                state.selectedDashboards.add(id);
                handleBulkChangeOwner();
            } else if (e.target.classList.contains('delete-btn')) {
                const id = parseInt(e.target.dataset.id);
                state.selectedDashboards.clear();
                state.selectedDashboards.add(id);
                handleBulkDelete();
            }
        });

        document.getElementById('bulkChangeOwnerBtn').addEventListener('click', handleBulkChangeOwner);
        document.getElementById('bulkShareBtn').addEventListener('click', handleBulkShare);
        document.getElementById('bulkDeleteBtn').addEventListener('click', handleBulkDelete);

        document.getElementById('prevPageBtn').addEventListener('click', () => {
            if (state.currentPage > 1) {
                state.currentPage--;
                renderDashboards();
            }
        });

        document.getElementById('nextPageBtn').addEventListener('click', () => {
            const totalPages = Math.ceil(state.filteredDashboards.length / state.itemsPerPage);
            if (state.currentPage < totalPages) {
                state.currentPage++;
                renderDashboards();
            }
        });

        // Modal event listeners
        document.getElementById('cancelChangeOwner').addEventListener('click', () => hideModal('changeOwnerModal'));
        document.getElementById('confirmChangeOwner').addEventListener('click', confirmChangeOwner);

        document.getElementById('cancelModifySharing').addEventListener('click', () => hideModal('modifySharingModal'));
        document.getElementById('confirmModifySharing').addEventListener('click', confirmModifySharing);

        document.getElementById('cancelDelete').addEventListener('click', () => hideModal('deleteConfirmModal'));
        document.getElementById('confirmDelete').addEventListener('click', confirmDelete);

        document.getElementById('closeErrorModal').addEventListener('click', () => hideModal('errorModal'));
        document.getElementById('toggleErrorDetails').addEventListener('click', function() {
            const detailsDiv = document.getElementById('errorDetails');
            if (detailsDiv.style.display === 'none') {
                detailsDiv.style.display = 'block';
                this.textContent = 'Hide Technical Details';
            } else {
                detailsDiv.style.display = 'none';
                this.textContent = 'Show Technical Details';
            }
        });

        // Close modals on outside click
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('show');
                }
            });
        });

        // Load saved config on page load
        window.addEventListener('DOMContentLoaded', () => {
            const savedConfig = sessionStorage.getItem('eh_config');
            if (savedConfig) {
                const config = JSON.parse(savedConfig);
                if (config.type === '360') {
                    document.getElementById('deploymentType').value = '360';
                    document.getElementById('tenantName').value = config.tenant;
                    document.getElementById('apiId').value = config.apiId;
                    document.getElementById('apiSecret').value = config.apiSecret;
                } else {
                    document.getElementById('deploymentType').value = 'enterprise';
                    document.getElementById('enterpriseHost').value = config.host;
                    document.getElementById('enterpriseApiKey').value = config.apiKey;
                    document.getElementById('config360').style.display = 'none';
                    document.getElementById('configEnterprise').style.display = 'block';
                }
            }
        });
    </script>
</body>
</html>
