<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ExtraHop API Tools</title>
    <link rel="icon" href="favicon.png" type="image/png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Source+Sans+3:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <!-- Fixed Top Ribbon -->
    <div class="top-ribbon">
        <img src="eh_logo.png" alt="ExtraHop" class="ribbon-logo">
        <span class="ribbon-title">API Tools</span>
        <span id="ribbonModuleTitle" class="ribbon-module-title"></span>
    </div>

    <div class="content-wrapper flex flex-col lg:flex-row min-h-screen">
        <!-- Sidebar -->
        <aside class="w-full lg:w-80 border-r p-6 space-y-6 lg:fixed lg:h-full lg:overflow-y-auto">
            <!-- API Configuration -->
            <div id="apiConfigSection" class="space-y-4">
                <!-- Collapsed Connected State -->
                <div id="connectedState" class="hidden">
                    <div class="flex items-center justify-between p-3 rounded cursor-pointer" style="background-color: var(--bg-subtle);" onclick="app.toggleApiConfig()">
                        <div class="flex items-center">
                            <svg class="w-5 h-5 mr-2" style="color: var(--cyan);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                            </svg>
                            <span class="font-semibold" style="color: var(--text-primary);">Connected</span>
                        </div>
                        <svg id="expandIcon" class="w-5 h-5 transition-transform" style="color: var(--text-secondary);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </div>
                    <p class="text-xs mt-2 text-center" style="color: var(--text-muted);" id="connectedInfo"></p>
                </div>

                <!-- Expanded Config Form -->
                <div id="configForm">
                    <h2 class="text-lg font-semibold" style="color: var(--text-primary);">API Configuration</h2>
                
                    <!-- Deployment Type -->
                    <div>
                        <label class="block text-sm font-medium mb-2" style="color: var(--text-secondary);">Deployment Type</label>
                        <select id="deploymentType" class="w-full px-3 py-2 rounded border">
                            <option value="360">RevealX 360 (Cloud)</option>
                            <option value="enterprise">RevealX Enterprise (Self-Hosted)</option>
                        </select>
                    </div>

                    <!-- 360 Config -->
                    <div id="config360" class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium mb-2" style="color: var(--text-secondary);">Tenant Name</label>
                            <input type="text" id="tenantName" placeholder="e.g., extrahop-se" class="w-full px-3 py-2 rounded border">
                            <p class="text-xs mt-1" style="color: var(--text-muted);">From: tenant.api.cloud.extrahop.com</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2" style="color: var(--text-secondary);">API ID</label>
                            <input type="text" id="apiId" class="w-full px-3 py-2 rounded border">
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium mb-2" style="color: var(--text-secondary);">API Secret</label>
                            <input type="password" id="apiSecret" class="w-full px-3 py-2 rounded border">
                        </div>
                        <div class="mb-4">
                            <label class="flex items-center cursor-pointer">
                                <input type="checkbox" id="useAwsProxy" checked class="mr-2">
                                <span class="text-sm" style="color: var(--text-secondary);">Use AWS Proxy</span>
                                <span class="ml-2 text-xs" style="color: var(--text-muted);" title="The proxy allows API requests without configuring CORS on your tenant. Contact support to configure CORS if you want to make direct API calls.">ℹ️</span>
                            </label>
                            <p class="text-xs mt-1 ml-6" style="color: var(--text-muted);">Unchecking requires CORS configuration on tenant</p>
                        </div>
                    </div>

                    <!-- Enterprise Config -->
                    <div id="configEnterprise" class="space-y-3" style="display: none;">
                        <div>
                            <label class="block text-sm font-medium mb-2" style="color: var(--text-secondary);">Hostname or IP</label>
                            <input type="text" id="enterpriseHost" placeholder="e.g., extrahop.company.com" class="w-full px-3 py-2 rounded border">
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium mb-2" style="color: var(--text-secondary);">API Key</label>
                            <input type="password" id="enterpriseApiKey" class="w-full px-3 py-2 rounded border">
                        </div>
                        <div class="mb-4 p-3 rounded" style="background-color: var(--bg-subtle);">
                            <p class="text-xs mb-2" style="color: var(--text-muted);">
                                <strong>Note:</strong> Web-based API requests require CORS to be configured on your RevealX Enterprise appliance.
                            </p>
                            <a href="https://docs.extrahop.com/current/rest-api-guide/#:~:text=Configure%20cross%2Dorigin%20resource%20sharing%20(CORS)" 
                               target="_blank" 
                               rel="noopener noreferrer" 
                               class="text-xs flex items-center gap-1" 
                               style="color: var(--cyan);">
                                <span>Configure CORS on RevealX Enterprise</span>
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                                </svg>
                            </a>
                        </div>
                    </div>

                    <button id="connectBtn" class="btn-primary w-full px-4 py-2 rounded font-semibold">
                        Connect
                    </button>

                    <div id="connectionStatus" class="text-sm text-center" style="display: none;">
                        <span id="statusText"></span>
                    </div>
                </div>
            </div>

            <!-- Module Selection -->
            <div class="space-y-2" id="moduleSelection" style="display: none;">
                <h2 class="text-lg font-semibold mb-3" style="color: var(--text-primary);">Tools</h2>
                
                <button class="module-btn w-full text-left px-4 py-3 rounded" data-module="audit-logs">
                    <div class="font-semibold">Audit Log Analyzer</div>
                    <div class="text-xs" style="color: var(--text-muted);">Analyze user activity and operation trends</div>
                </button>

                <button class="module-btn w-full text-left px-4 py-3 rounded" data-module="dashboards">
                    <div class="font-semibold">Dashboard Manager</div>
                    <div class="text-xs" style="color: var(--text-muted);">Manage ownership & sharing</div>
                </button>

                <button class="module-btn w-full text-left px-4 py-3 rounded" data-module="localities">
                    <div class="font-semibold">Network Localities Manager</div>
                    <div class="text-xs" style="color: var(--text-muted);">Manage network locality entries</div>
                </button>

                <button class="module-btn w-full text-left px-4 py-3 rounded" data-module="crs-usage">
                    <div class="font-semibold">Records Report</div>
                    <div class="text-xs" style="color: var(--text-muted);">Capacity & compression analysis</div>
                </button>

                <a href="nodemap.html" target="_blank" rel="noopener noreferrer" class="module-btn w-full text-left px-4 py-3 rounded flex items-center justify-between" style="display: block; text-decoration: none;">
                    <div>
                        <div class="font-semibold">Appliance Node Map</div>
                        <div class="text-xs" style="color: var(--text-muted);">Visualize topology</div>
                    </div>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                    </svg>
                </a>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 lg:ml-80 p-6" id="mainContent">
            <!-- Welcome Screen -->
            <div id="welcomeScreen">
                <div class="max-w-2xl mx-auto text-center py-20">
                    <h2 class="text-3xl font-bold mb-4" style="color: var(--sapphire);">Welcome to ExtraHop API Tools</h2>
                    <p class="text-lg mb-8" style="color: var(--text-secondary);">
                        A collection of web-based utilities for ExtraHop administrators to streamline common API-driven workflows.
                    </p>
                    <div class="space-y-4 text-left" style="color: var(--text-muted);">
                        <div class="flex items-start">
                            <svg class="w-6 h-6 mr-3 flex-shrink-0" style="color: var(--cyan);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                            </svg>
                            <div>
                                <strong>Client-Side Processing</strong> - All operations run in your browser. No data is sent to third-party servers beyond your ExtraHop instance.
                            </div>
                        </div>
                        <div class="flex items-start">
                            <svg class="w-6 h-6 mr-3 flex-shrink-0" style="color: var(--cyan);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                            </svg>
                            <div>
                                <strong>Session-Based Security</strong> - API credentials are stored only in browser session storage and cleared when you close the tab.
                            </div>
                        </div>
                        <div class="flex items-start">
                            <svg class="w-6 h-6 mr-3 flex-shrink-0" style="color: var(--cyan);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"></path>
                            </svg>
                            <div>
                                <strong>Multiple Tools Available</strong> - Access various administrative utilities from the sidebar menu after connecting to your ExtraHop instance.
                            </div>
                        </div>
                    </div>
                    <div class="mt-8 p-4 rounded-lg" style="background-color: var(--bg-subtle); border-left: 4px solid var(--cyan);">
                        <p class="text-sm text-left" style="color: var(--text-secondary);">
                            <strong>Getting Started:</strong> Configure your connection above, then select a tool from the sidebar to begin. Each tool includes instructions and controls for its specific functionality.
                        </p>
                    </div>
                </div>
            </div>

            <!-- Module content will be loaded dynamically here -->
        </main>
    </div>

    <!-- Modal containers and other shared elements will be loaded by modules -->

    <!-- Scripts -->
    <script src="js/auth.js"></script>
    <script src="js/api-client.js"></script>
    <script src="js/modules/dashboard-manager.js"></script>
    <script src="js/modules/appliance-metrics.js"></script>
    <script src="js/modules/network-localities.js"></script>
    <script src="js/modules/audit-log.js"></script>
    
    <script>
        // Main Application Controller
        class App {
            constructor() {
                this.currentModule = null;
                this.modules = {
                    'dashboards': new DashboardManager(),
                    'crs-usage': new ApplianceMetrics(),
                    'localities': new NetworkLocalities(),
                    'audit-logs': new AuditLog()
                };
            }

            async init() {
                // Try to restore session on page load
                try {
                    const api = await window.auth.restoreSession();
                    if (api) {
                        window.apiClient = api;
                        this.showConnectedState();
                        this.showModuleSelection();
                    }
                } catch (error) {
                    console.log('No valid session found:', error.message);
                }

                this.setupEventListeners();
            }

            setupEventListeners() {
                // Deployment type toggle
                document.getElementById('deploymentType').addEventListener('change', (e) => {
                    const is360 = e.target.value === '360';
                    document.getElementById('config360').style.display = is360 ? 'block' : 'none';
                    document.getElementById('configEnterprise').style.display = is360 ? 'none' : 'block';
                });

                // Connect button
                document.getElementById('connectBtn').addEventListener('click', () => this.handleConnect());

                // Module buttons
                document.querySelectorAll('.module-btn[data-module]').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const module = e.currentTarget.dataset.module;
                        console.log('Module button clicked:', module, 'Connected:', window.auth.isConnected);
                        if (window.auth.isConnected) {
                            this.switchModule(module);
                        } else {
                            console.warn('Not connected to ExtraHop instance');
                        }
                    });
                });
            }

            async handleConnect() {
                const connectBtn = document.getElementById('connectBtn');
                const deploymentType = document.getElementById('deploymentType').value;
                
                let config = { type: deploymentType };

                if (deploymentType === '360') {
                    config.tenant = document.getElementById('tenantName').value.trim();
                    config.apiId = document.getElementById('apiId').value.trim();
                    config.apiSecret = document.getElementById('apiSecret').value.trim();
                    config.useProxy = document.getElementById('useAwsProxy').checked;
                } else {
                    config.host = document.getElementById('enterpriseHost').value.trim();
                    config.apiKey = document.getElementById('enterpriseApiKey').value.trim();
                }

                try {
                    connectBtn.disabled = true;
                    connectBtn.textContent = 'Connecting...';
                    this.showStatus('Connecting...', false);

                    const api = await window.auth.connect(config);
                    
                    if (api) {
                        window.apiClient = api;
                        this.showConnectedState();
                        this.showModuleSelection();
                        this.showStatus('✓ Connected successfully', false);

                        setTimeout(() => {
                            document.getElementById('connectionStatus').style.display = 'none';
                        }, 2000);
                    }

                } catch (error) {
                    this.showStatus('✗ ' + error.message, true);
                } finally {
                    connectBtn.textContent = 'Connect';
                    connectBtn.disabled = false;
                }
            }

            showStatus(message, isError = false) {
                const statusDiv = document.getElementById('connectionStatus');
                const statusText = document.getElementById('statusText');
                statusDiv.style.display = 'block';
                statusText.textContent = message;
                statusText.style.color = isError ? '#ef4444' : 'var(--cyan)';
            }

            toggleApiConfig() {
                const configForm = document.getElementById('configForm');
                const expandIcon = document.getElementById('expandIcon');
                
                if (configForm.style.display === 'none') {
                    configForm.style.display = 'block';
                    expandIcon.style.transform = 'rotate(0deg)';
                } else {
                    configForm.style.display = 'none';
                    expandIcon.style.transform = 'rotate(-90deg)';
                }
            }

            showConnectedState() {
                const connectedState = document.getElementById('connectedState');
                const configForm = document.getElementById('configForm');
                const connectedInfo = document.getElementById('connectedInfo');
                
                connectedState.classList.remove('hidden');
                configForm.style.display = 'none';
                
                const info = window.auth.getConnectionInfo();
                if (info) {
                    connectedInfo.textContent = `${info.type}: ${info.endpoint}`;
                }
                
                document.getElementById('expandIcon').style.transform = 'rotate(-90deg)';
            }

            showModuleSelection() {
                document.getElementById('moduleSelection').style.display = 'block';
            }

            async switchModule(moduleKey) {
                console.log('switchModule called:', moduleKey, 'current:', this.currentModule);
                
                // Don't switch if already on this module
                if (this.currentModule === moduleKey) {
                    console.log('Already on this module, skipping');
                    return;
                }

                // Deactivate current module
                if (this.currentModule && this.modules[this.currentModule]) {
                    console.log('Deactivating current module:', this.currentModule);
                    this.modules[this.currentModule].deactivate();
                }

                // Clear module buttons
                document.querySelectorAll('.module-btn').forEach(btn => btn.classList.remove('active'));

                // Hide welcome screen
                document.getElementById('welcomeScreen').style.display = 'none';

                // Activate new module
                if (this.modules[moduleKey]) {
                    console.log('Activating new module:', moduleKey);
                    this.currentModule = moduleKey;
                    
                    // Mark button as active
                    const btn = document.querySelector(`[data-module="${moduleKey}"]`);
                    if (btn) btn.classList.add('active');

                    // Load module content
                    await this.loadModuleContent(moduleKey);
                    
                    // Activate module
                    this.modules[moduleKey].activate();
                    console.log('Module activated successfully');
                } else {
                    console.warn(`Module ${moduleKey} not found`);
                }
            }

            async loadModuleContent(moduleKey) {
                const mainContent = document.getElementById('mainContent');
                
                // Get template from module if it has one
                if (this.modules[moduleKey] && this.modules[moduleKey].getTemplate) {
                    mainContent.innerHTML = this.modules[moduleKey].getTemplate();
                } else {
                    // Fallback to basic content
                    mainContent.innerHTML = this.getModuleContentFallback(moduleKey);
                }
            }

            getModuleContentFallback(moduleKey) {
                // Basic fallback content for each module
                const fallbacks = {
                    'dashboards': '<div><h2>Dashboard Manager</h2><p>Loading dashboard management interface...</p></div>',
                    'audit-logs': '<div><h2>Audit Log Analyzer</h2><p>Loading audit log interface...</p></div>',
                    'localities': '<div><h2>Network Localities</h2><p>Loading network localities interface...</p></div>',
                    'crs-usage': '<div><h2>Records Report</h2><p>Loading records report interface...</p></div>'
                };
                
                return fallbacks[moduleKey] || '<div><h2>Module</h2><p>Content not available</p></div>';
            }
        }

        // Initialize application
        window.app = new App();
        
        // Wait for DOM to be ready
        document.addEventListener('DOMContentLoaded', () => {
            window.app.init();
        });

        // Global utility functions for backwards compatibility
        function showErrorModal(message, details) {
            alert(`Error: ${message}\n\nDetails: ${JSON.stringify(details, null, 2)}`);
        }
    </script>
</body>
</html>